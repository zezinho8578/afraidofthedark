<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afraid of the Dark - Combat Manager</title>
    <link rel="icon" type="image/png" href="https://media.discordapp.net/attachments/1461536234034827537/1461536302825738250/AOTD_typography_short.png?ex=696c3ac0&is=696ae940&hm=03b59631e6cf033690b321071c0e82b80acf7946c252e1b5947119a613d299b0&=&format=webp&quality=lossless">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Screenshot library -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        /* === CORE THEME === */
        @keyframes flicker { 0%, 100% { opacity: 0.97; } 50% { opacity: 1; } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px var(--active-glow); } 50% { box-shadow: 0 0 20px var(--active-glow), 0 0 30px var(--active-glow); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes criticalPulse { 0%, 100% { background-color: var(--danger-color); } 50% { background-color: #ff0000; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }

        :root {
            --bg-color: #0a0a0a;
            --scanline-color: rgba(255, 255, 255, 0.02);
            --text-color: #d0d0d0;
            --accent-color: #ffffff;
            --border-color: #333333;
            --input-bg: #141414;
            --danger-color: #a30000;
            --danger-bg: rgba(100, 0, 0, 0.15);
            --success-color: #00aa00;
            --warning-color: #ffaa00;
            --container-bg: rgba(15, 15, 15, 0.95);
            --active-glow: #00f3ff;
            --enemy-color: #ff4444;
            --ally-color: #44ff44;
            --npc-color: #ffaa44;
            --player-color: #4488ff;
        }

        body.theme-dark { --bg-color: #0a0a0a; --text-color: #d0d0d0; --accent-color: #ffffff; --border-color: #333333; --input-bg: #141414; --container-bg: rgba(15, 15, 15, 0.95); }
        body.theme-terminal { --bg-color: #0a0f0a; --text-color: #00ff00; --accent-color: #00ff00; --border-color: #003300; --input-bg: #0a1a0a; --danger-color: #ff3300; --container-bg: rgba(10, 20, 10, 0.95); --active-glow: #00ff00; }
        body.theme-crimson { --bg-color: #0f0808; --text-color: #e0c0c0; --accent-color: #ff4444; --border-color: #442222; --input-bg: #1a0a0a; --danger-color: #ff0000; --container-bg: rgba(20, 10, 10, 0.95); --active-glow: #ff4444; }
        body.theme-light { --bg-color: #f0f0f0; --scanline-color: rgba(0, 0, 0, 0.02); --text-color: #1a1a1a; --accent-color: #000000; --border-color: #cccccc; --input-bg: #ffffff; --danger-color: #cc0000; --danger-bg: rgba(200, 0, 0, 0.1); --container-bg: rgba(255, 255, 255, 0.95); }
        body.theme-highcontrast { --bg-color: #000000; --text-color: #ffffff; --accent-color: #ffff00; --border-color: #ffffff; --input-bg: #000000; --danger-color: #ff0000; --danger-bg: rgba(255, 0, 0, 0.2); --container-bg: #000000; }

        body.reduce-motion, body.reduce-motion * { animation: none !important; transition: none !important; }
        body.large-text { font-size: 18px; }
        body.xlarge-text { font-size: 22px; }

        body {
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            animation: flicker 0.2s infinite;
            overflow-x: hidden;
            min-height: 100vh;
        }

        body::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(0deg, var(--scanline-color) 1px, transparent 1px);
            background-size: 100% 3px; z-index: 1000; pointer-events: none;
        }

        body.no-scanlines::before { display: none; }

        .hidden { display: none !important; }

        /* === LAYOUT === */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 15px;
            background: var(--container-bg);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo { height: 40px; filter: invert(1) brightness(0.8); }
        body.theme-light .header-logo { filter: none; }

        .header h1 {
            font-size: 16px;
            letter-spacing: 3px;
            margin: 0;
            color: var(--accent-color);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* === BUTTONS === */
        button, .button {
            background: rgba(255,255,255,0.05);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            transition: all 0.2s;
            white-space: nowrap;
        }

        button:hover:not(:disabled) { background: var(--text-color); color: var(--bg-color); border-color: var(--accent-color); }
        button:disabled { cursor: not-allowed; opacity: 0.3; }
        button.btn-danger { border-color: var(--danger-color); color: var(--danger-color); }
        button.btn-danger:hover { background: var(--danger-color); color: #fff; }
        button.btn-success { border-color: var(--success-color); color: var(--success-color); }
        button.btn-success:hover { background: var(--success-color); color: #000; }
        button.btn-warning { border-color: var(--warning-color); color: var(--warning-color); }
        button.btn-warning:hover { background: var(--warning-color); color: #000; }
        button.btn-primary { border-color: var(--active-glow); color: var(--active-glow); }
        button.btn-primary:hover { background: var(--active-glow); color: #000; }
        button.btn-large { padding: 10px 20px; font-size: 14px; }

        /* === INPUTS === */
        input, select, textarea {
            background-color: #000;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
        }

        body.theme-light input, body.theme-light select, body.theme-light textarea { background-color: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-color); outline: none; }
        input[type="number"] { width: 60px; text-align: center; }
        input[type="number"].small { width: 45px; }

        label {
            font-size: 11px;
            color: #888;
            letter-spacing: 1px;
            text-transform: uppercase;
            display: block;
            margin-bottom: 3px;
        }

        /* === MAIN LAYOUT === */
        .combat-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 15px;
            min-height: calc(100vh - 100px);
        }

        @media (max-width: 1200px) {
            .combat-layout { grid-template-columns: 1fr; }
            .sidebar-left, .sidebar-right { order: 2; }
            .main-area { order: 1; }
        }

        .sidebar-left, .sidebar-right, .main-area {
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
        }

        .panel-header h2 {
            font-size: 13px;
            margin: 0;
            letter-spacing: 2px;
            color: var(--accent-color);
        }

        .panel-content {
            padding: 10px;
            flex: 1;
            overflow-y: auto;
        }

        /* === COMBAT STATUS BAR === */
        .combat-status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: linear-gradient(90deg, rgba(0,243,255,0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 10px;
        }

        .combat-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .combat-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .combat-info-item .label { font-size: 11px; color: #666; }
        .combat-info-item .value { font-size: 16px; font-weight: bold; color: var(--accent-color); }

        .round-counter {
            font-size: 24px;
            font-weight: bold;
            color: var(--active-glow);
            text-shadow: 0 0 10px var(--active-glow);
        }

        /* === INITIATIVE TRACKER === */
        .initiative-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .initiative-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            cursor: pointer;
        }

        .initiative-item:hover { border-color: var(--text-color); }

        .initiative-item.active {
            border-color: var(--active-glow);
            background: rgba(0, 243, 255, 0.1);
            animation: glow 2s infinite;
        }

        .initiative-item.dead {
            opacity: 0.3;
            text-decoration: line-through;
        }

        .initiative-item.delayed {
            opacity: 0.6;
            border-style: dashed;
        }

        .init-order {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--border-color);
            font-weight: bold;
            font-size: 12px;
        }

        .init-type-indicator {
            width: 4px;
            height: 100%;
            min-height: 30px;
            flex-shrink: 0;
        }

        .init-type-indicator.player { background: var(--player-color); }
        .init-type-indicator.enemy { background: var(--enemy-color); }
        .init-type-indicator.ally { background: var(--ally-color); }
        .init-type-indicator.npc { background: var(--npc-color); }

        .init-info { flex: 1; min-width: 0; }
        .init-name { font-weight: bold; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .init-stats { font-size: 11px; color: #888; display: flex; gap: 10px; margin-top: 2px; }

        .init-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-color);
            min-width: 30px;
            text-align: center;
        }

        .init-actions {
            display: flex;
            gap: 3px;
        }

        .init-actions button {
            padding: 3px 6px;
            font-size: 10px;
        }

        /* === COMBATANT CARDS === */
        .combatant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .combatant-card {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            padding: 0;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .combatant-card.active {
            border-color: var(--active-glow);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
        }

        .combatant-card.dead {
            opacity: 0.4;
            filter: grayscale(80%);
        }

        .combatant-card.player { border-left: 4px solid var(--player-color); }
        .combatant-card.enemy { border-left: 4px solid var(--enemy-color); }
        .combatant-card.ally { border-left: 4px solid var(--ally-color); }
        .combatant-card.npc { border-left: 4px solid var(--npc-color); }

        .card-header {
            padding: 10px 12px;
            background: rgba(0,0,0,0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .card-name {
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-name input {
            background: transparent;
            border: none;
            border-bottom: 1px dashed var(--border-color);
            color: var(--text-color);
            font-weight: bold;
            font-size: 14px;
            width: 150px;
        }

        .card-type-badge {
            font-size: 9px;
            padding: 2px 6px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .card-type-badge.player { background: var(--player-color); color: #000; }
        .card-type-badge.enemy { background: var(--enemy-color); color: #000; }
        .card-type-badge.ally { background: var(--ally-color); color: #000; }
        .card-type-badge.npc { background: var(--npc-color); color: #000; }

        .card-body { padding: 12px; }

        /* Health/Stats Bars */
        .stat-bars {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .stat-bar-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .stat-bar-header .label { color: #888; }
        .stat-bar-header .value { font-weight: bold; }

        .stat-bar {
            height: 8px;
            background: #222;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            transition: width 0.3s, background-color 0.3s;
        }

        .stat-bar-fill.hp { background: linear-gradient(90deg, #00aa00, #44ff44); }
        .stat-bar-fill.hp.critical { background: linear-gradient(90deg, #aa0000, #ff4444); animation: criticalPulse 1s infinite; }
        .stat-bar-fill.hp.wounded { background: linear-gradient(90deg, #aa6600, #ffaa00); }
        .stat-bar-fill.wp { background: linear-gradient(90deg, #0066aa, #44aaff); }
        .stat-bar-fill.san { background: linear-gradient(90deg, #6600aa, #aa44ff); }
        .stat-bar-fill.armor { background: linear-gradient(90deg, #666666, #aaaaaa); }

        .stat-inputs {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 4px;
        }

        .stat-inputs input {
            width: 40px;
            text-align: center;
            padding: 4px;
            font-size: 12px;
        }

        .stat-inputs span { color: #666; }

        /* Attributes Grid */
        .attributes-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
        }

        .attr-item {
            text-align: center;
        }

        .attr-label {
            font-size: 9px;
            color: #666;
            letter-spacing: 1px;
        }

        .attr-value {
            font-size: 14px;
            font-weight: bold;
        }

        .attr-x5 {
            font-size: 10px;
            color: #888;
        }

        /* Skills Section */
        .skills-section {
            margin-bottom: 12px;
        }

        .skills-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .skill-tag {
            font-size: 10px;
            padding: 3px 8px;
            background: var(--border-color);
            border: 1px solid #444;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .skill-tag .skill-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        /* Weapons Section */
        .weapons-section {
            margin-bottom: 12px;
        }

        .weapon-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            margin-bottom: 4px;
            font-size: 11px;
        }

        .weapon-name { font-weight: bold; flex: 1; }
        .weapon-stat { color: #888; }
        .weapon-stat strong { color: var(--accent-color); }

        .weapon-actions {
            display: flex;
            gap: 3px;
        }

        .weapon-actions button {
            padding: 2px 6px;
            font-size: 9px;
        }

        /* Status Effects */
        .status-effects {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }

        .status-tag {
            font-size: 9px;
            padding: 2px 6px;
            letter-spacing: 1px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-tag.negative { background: var(--danger-color); color: #fff; }
        .status-tag.positive { background: var(--success-color); color: #000; }
        .status-tag.neutral { background: var(--warning-color); color: #000; }

        .status-tag .remove-status {
            cursor: pointer;
            font-weight: bold;
            margin-left: 4px;
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .card-actions button {
            flex: 1;
            min-width: 60px;
            padding: 5px 8px;
            font-size: 10px;
        }

        /* === ACTION PANEL === */
        .action-panel {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .action-panel-header {
            padding: 10px 15px;
            background: rgba(0,243,255,0.1);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-panel-header h3 {
            margin: 0;
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--active-glow);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            padding: 15px;
        }

        .action-btn {
            padding: 12px 10px;
            text-align: center;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .action-btn .icon {
            font-size: 20px;
        }

        /* === COMBAT LOG === */
        .combat-log {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .log-entry {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            line-height: 1.5;
            animation: slideIn 0.3s ease;
        }

        .log-entry.round-marker {
            background: rgba(0,243,255,0.1);
            text-align: center;
            font-weight: bold;
            color: var(--active-glow);
            letter-spacing: 2px;
        }

        .log-entry.attack { border-left: 3px solid var(--danger-color); }
        .log-entry.damage { border-left: 3px solid #ff6600; }
        .log-entry.heal { border-left: 3px solid var(--success-color); }
        .log-entry.status { border-left: 3px solid var(--warning-color); }
        .log-entry.move { border-left: 3px solid var(--player-color); }
        .log-entry.system { border-left: 3px solid #888; color: #888; }

        .log-timestamp {
            font-size: 10px;
            color: #555;
            margin-right: 8px;
        }

        .log-actor { font-weight: bold; color: var(--accent-color); }
        .log-target { color: var(--warning-color); }
        .log-roll { color: var(--active-glow); font-weight: bold; }
        .log-damage { color: var(--danger-color); font-weight: bold; }
        .log-success { color: var(--success-color); }
        .log-failure { color: var(--danger-color); }
        .log-critical { color: #ff00ff; font-weight: bold; text-transform: uppercase; }

        /* === QUICK ADD PANEL === */
        .quick-add-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .template-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-top: 10px;
        }

        .template-btn {
            padding: 8px;
            font-size: 10px;
            text-align: left;
        }

        .template-btn .template-name { font-weight: bold; display: block; }
        .template-btn .template-stats { font-size: 9px; color: #888; }

        /* === DICE ROLLER === */
        .dice-roller {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 10px;
        }

        .dice-roller h4 {
            margin: 0 0 10px 0;
            font-size: 11px;
            letter-spacing: 1px;
            color: #888;
        }

        .dice-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .dice-result {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
        }

        .dice-result .result-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .dice-result .result-breakdown {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        /* === MODALS === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 500;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background: var(--bg-color);
            border: 2px solid var(--accent-color);
            padding: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 16px;
            letter-spacing: 2px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            box-sizing: border-box;
        }

        /* === LETHALITY ROLL DISPLAY === */
        .lethality-display {
            text-align: center;
            padding: 20px;
            background: rgba(255,0,0,0.1);
            border: 2px solid var(--danger-color);
            margin: 10px 0;
        }

        .lethality-display .lethality-title {
            font-size: 14px;
            color: var(--danger-color);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .lethality-display .lethality-roll {
            font-size: 48px;
            font-weight: bold;
        }

        .lethality-display .lethality-result {
            font-size: 18px;
            margin-top: 10px;
            letter-spacing: 3px;
        }

        .lethality-display .lethality-result.killed { color: var(--danger-color); }
        .lethality-display .lethality-result.survived { color: var(--success-color); }

        .lethality-display .lethality-damage {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }

        /* === CONNECTION STATUS === */
        .connection-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
        }

        .connection-badge.connected { border-color: var(--success-color); color: var(--success-color); }
        .connection-badge.disconnected { border-color: var(--danger-color); color: var(--danger-color); }
        .connection-badge.connecting { border-color: var(--warning-color); color: var(--warning-color); }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* === PLAYER VIEW MODE === */
        .player-mode .admin-only { display: none !important; }
        .player-mode .combatant-card:not(.active):not([data-owner="player"]) { opacity: 0.6; }
        .player-mode .combatant-card:not([data-owner="player"]) .card-actions { display: none; }
        .player-mode .combatant-card:not([data-owner="player"]) input { pointer-events: none; }

        /* === SHARE LINK === */
        .share-link-container {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .share-link-container input {
            flex: 1;
            font-size: 11px;
            padding: 6px 10px;
        }

        /* === LOADING === */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 600;
        }
        
        /* === LOGIN OVERLAY (FROM FILE 1) === */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000;
            z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box { border: 2px solid var(--active-glow); padding: 40px; text-align: center; max-width: 400px; }
        .login-box h2 { color: var(--active-glow); letter-spacing: 4px; margin-bottom: 30px; }
        .login-box input { width: 100%; margin-bottom: 20px; font-size: 16px; text-align: center; padding: 10px; }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top-color: var(--active-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 20px;
            letter-spacing: 3px;
            animation: blink 1s infinite;
        }

        /* === SCREENSHOT AREA === */
        #screenshot-area {
            background: var(--bg-color);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .combat-layout { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 10px; }
            .header-right { flex-wrap: wrap; justify-content: center; }
            .combatant-grid { grid-template-columns: 1fr; }
            .attributes-grid { grid-template-columns: repeat(3, 1fr); }
            .action-buttons { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body class="theme-dark">

    <!-- LOGIN SCREEN (Re-integrated from File 1) -->
    <div id="login-screen" class="login-overlay">
        <div class="login-box">
            <h2 id="login-title">SYSTEM ACCESS</h2>
            <div id="login-message" style="color: #666; margin-bottom: 15px; font-size: 12px;">ENTER CREDENTIALS</div>
            <input type="password" id="login-input" placeholder="PASSWORD" onkeypress="handleLoginKey(event)">
            <button onclick="attemptLogin()" class="btn-primary" style="width: 100%; padding: 10px;">ACCESS</button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text">INITIALIZING COMBAT SYSTEM...</div>
    </div>

    <!-- MAIN APP CONTAINER (Starts hidden until login) -->
    <div class="container hidden" id="main-app">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <img src="https://media.discordapp.net/attachments/1461536234034827537/1461536301856592004/AOTD_logo_1.png?ex=696c3ac0&is=696ae940&hm=83305b949f27d28be9e8299caa9967678c2d749fc6a043361dba87a1145cafe2&=&format=webp&quality=lossless" alt="AOTD" class="header-logo">
                <h1>COMBAT MANAGER</h1>
            </div>
            <div class="header-right">
                <div id="connection-badge" class="connection-badge connecting">
                    <span class="connection-dot"></span>
                    <span>CONNECTING</span>
                </div>

                <!-- Added user-display from File 1 -->
                <span id="user-display" style="font-size: 11px; color: var(--active-glow);"></span>
                
                <button onclick="window.location.href='index.html'">‚Üê TERMINAL</button>

                <div class="admin-only">
                    <button onclick="openSettingsModal()">‚öô SETTINGS</button>
                    <button onclick="screenshotCombat()" class="btn-primary">üì∑ SCREENSHOT</button>
                </div>

                <button id="admin-logout-btn" onclick="toggleAdminMode()" class="hidden">ADMIN LOGOUT</button>
            </div>
        </header>

        <!-- Combat Status Bar -->
        <div class="combat-status-bar" id="combat-status-bar">
            <div class="combat-info">
                <div class="combat-info-item">
                    <span class="label">ROUND</span>
                    <span class="round-counter" id="round-counter">1</span>
                </div>
                <div class="combat-info-item">
                    <span class="label">PHASE</span>
                    <span class="value" id="combat-phase">SETUP</span>
                </div>
                <div class="combat-info-item">
                    <span class="label">ACTIVE</span>
                    <span class="value" id="active-combatant-name">---</span>
                </div>
            </div>
            <div class="combat-controls admin-only">
                <button onclick="startCombat()" id="start-combat-btn" class="btn-success btn-large">‚ñ∂ START COMBAT</button>
                <button onclick="nextTurn()" id="next-turn-btn" class="btn-primary btn-large" disabled>NEXT TURN ‚Üí</button>
                <button onclick="previousTurn()" class="btn-warning" disabled id="prev-turn-btn">‚Üê PREV</button>
                <button onclick="newRound()" class="btn-warning">NEW ROUND</button>
                <button onclick="endCombat()" class="btn-danger">END COMBAT</button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="combat-layout" id="screenshot-area">
            <!-- Left Sidebar: Initiative Order -->
            <aside class="sidebar-left">
                <div class="panel-header">
                    <h2>INITIATIVE ORDER</h2>
                    <!-- Modified from "ROLL ALL" to "SORT (DEX)" to implement File 1's feature -->
                    <button class="admin-only" onclick="sortInitiative()" id="init-sort-btn" style="font-size:10px;padding:4px 8px;">SORT (DEX)</button>
                </div>
                <div class="panel-content">
                    <div class="initiative-list" id="initiative-list">
                        <!-- Initiative items will be rendered here -->
                        <div class="empty-state" style="text-align:center;padding:20px;color:#555;">
                            No combatants added
                        </div>
                    </div>

                    <!-- Quick Add Section -->
                    <div class="quick-add-section admin-only">
                        <label>QUICK ADD</label>
                        <div style="display:flex;gap:5px;margin-bottom:10px;">
                            <button onclick="openAddCombatantModal('player')" class="btn-primary" style="flex:1;">+ PLAYER</button>
                            <button onclick="openAddCombatantModal('enemy')" class="btn-danger" style="flex:1;">+ ENEMY</button>
                        </div>
                        
                        <!-- Added Template Manager button from File 1 -->
                        <div style="display:flex;gap:5px;margin-bottom:10px;">
                             <button onclick="openTemplateManager()" style="flex:1;font-size:10px;">MANAGE TEMPLATES</button>
                        </div>

                        <label>ENEMY TEMPLATES</label>
                        <div class="template-grid" id="enemy-templates">
                            <!-- Templates will be rendered here -->
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Area: Combatant Cards -->
            <main class="main-area">
                <div class="panel-header">
                    <h2>COMBATANTS</h2>
                    <div class="admin-only" style="display:flex;gap:5px;">
                        <button onclick="openAddCombatantModal('player')">+ ADD</button>
                        <button onclick="clearAllCombatants()" class="btn-danger">CLEAR ALL</button>
                    </div>
                </div>

                <!-- Active Combatant Action Panel -->
                <div class="action-panel" id="action-panel" style="display:none;">
                    <div class="action-panel-header">
                        <h3>ACTIONS FOR: <span id="action-panel-name">---</span></h3>
                        <span id="action-panel-type" class="card-type-badge">---</span>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="performAction('attack')">
                            <span class="icon">‚öîÔ∏è</span>
                            <span>ATTACK</span>
                        </button>
                        <button class="action-btn" onclick="performAction('aim')">
                            <span class="icon">üéØ</span>
                            <span>AIM</span>
                        </button>
                        <button class="action-btn" onclick="performAction('dodge')">
                            <span class="icon">üí®</span>
                            <span>DODGE</span>
                        </button>
                        <button class="action-btn" onclick="performAction('move')">
                            <span class="icon">üèÉ</span>
                            <span>MOVE</span>
                        </button>
                        <button class="action-btn" onclick="performAction('fightback')">
                            <span class="icon">ü§∫</span>
                            <span>FIGHT BACK</span>
                        </button>
                        <button class="action-btn" onclick="performAction('disarm')">
                            <span class="icon">üñêÔ∏è</span>
                            <span>DISARM</span>
                        </button>
                        <button class="action-btn" onclick="performAction('reload')">
                            <span class="icon">üîÑ</span>
                            <span>RELOAD</span>
                        </button>
                        <button class="action-btn" onclick="performAction('firstaid')">
                            <span class="icon">ü©π</span>
                            <span>FIRST AID</span>
                        </button>
                        <button class="action-btn" onclick="performAction('called')">
                            <span class="icon">üé™</span>
                            <span>CALLED SHOT</span>
                        </button>
                        <button class="action-btn" onclick="performAction('pin')">
                            <span class="icon">üìç</span>
                            <span>PIN</span>
                        </button>
                        <button class="action-btn" onclick="performAction('delay')">
                            <span class="icon">‚è∏Ô∏è</span>
                            <span>DELAY</span>
                        </button>
                        <button class="action-btn" onclick="performAction('other')">
                            <span class="icon">‚ùì</span>
                            <span>OTHER</span>
                        </button>
                    </div>
                </div>

                <!-- Combatant Cards Grid -->
                <div class="combatant-grid" id="combatant-grid">
                    <!-- Combatant cards will be rendered here -->
                </div>
            </main>

            <!-- Right Sidebar: Combat Log & Dice -->
            <aside class="sidebar-right">
                <div class="panel-header">
                    <h2>COMBAT LOG</h2>
                    <button onclick="clearLog()" style="font-size:10px;padding:4px 8px;" class="admin-only">CLEAR</button>
                </div>
                <div class="panel-content" style="display:flex;flex-direction:column;">
                    <!-- Dice Roller -->
                    <div class="dice-roller">
                        <h4>DICE ROLLER</h4>
                        <div class="dice-buttons">
                            <button onclick="rollDice('1d4')">D4</button>
                            <button onclick="rollDice('1d6')">D6</button>
                            <button onclick="rollDice('1d8')">D8</button>
                            <button onclick="rollDice('1d10')">D10</button>
                            <button onclick="rollDice('1d12')">D12</button>
                            <button onclick="rollDice('1d20')">D20</button>
                            <button onclick="rollDice('1d100')">D100</button>
                            <button onclick="rollDice('2d6')">2D6</button>
                            <button onclick="openCustomRollModal()">CUSTOM</button>
                        </div>
                        <div class="dice-result" id="dice-result">
                            <div class="result-value">--</div>
                            <div class="result-breakdown"></div>
                        </div>
                    </div>

                    <!-- Log Entries -->
                    <div class="combat-log" id="combat-log">
                        <div class="log-entry system">
                            <span class="log-timestamp">[SYSTEM]</span>
                            Combat Manager initialized. Waiting for combatants...
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Add/Edit Combatant Modal -->
    <div id="combatant-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="combatant-modal-title">ADD COMBATANT</h2>
                <button onclick="closeCombatantModal()">‚úï CLOSE</button>
            </div>

            <form id="combatant-form" onsubmit="return false;">
                <input type="hidden" id="combatant-id">

                <div class="form-row">
                    <div class="form-group">
                        <label>NAME</label>
                        <input type="text" id="comb-name" placeholder="Enter name..." required>
                    </div>
                    <div class="form-group">
                        <label>TYPE</label>
                        <select id="comb-type">
                            <option value="player">PLAYER</option>
                            <option value="enemy">ENEMY</option>
                            <option value="ally">ALLY</option>
                            <option value="npc">NPC</option>
                        </select>
                    </div>
                </div>

                <h4 style="margin:15px 0 10px;font-size:12px;color:#888;border-bottom:1px solid var(--border-color);padding-bottom:5px;">ATTRIBUTES</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>STR</label>
                        <input type="number" id="comb-str" value="10" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label>DEX</label>
                        <input type="number" id="comb-dex" value="10" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label>CON</label>
                        <input type="number" id="comb-con" value="10" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label>INT</label>
                        <input type="number" id="comb-int" value="10" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label>POW</label>
                        <input type="number" id="comb-pow" value="10" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label>CHA</label>
                        <input type="number" id="comb-cha" value="10" min="1" max="20">
                    </div>
                </div>

                <h4 style="margin:15px 0 10px;font-size:12px;color:#888;border-bottom:1px solid var(--border-color);padding-bottom:5px;">DERIVED STATS</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>HP CURRENT</label>
                        <input type="number" id="comb-hp" value="10" min="0">
                    </div>
                    <div class="form-group">
                        <label>HP MAX</label>
                        <input type="number" id="comb-hp-max" value="10" min="1">
                    </div>
                    <div class="form-group">
                        <label>WP CURRENT</label>
                        <input type="number" id="comb-wp" value="10" min="0">
                    </div>
                    <div class="form-group">
                        <label>WP MAX</label>
                        <input type="number" id="comb-wp-max" value="10" min="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ARMOR</label>
                        <input type="number" id="comb-armor" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>SANITY</label>
                        <input type="number" id="comb-san" value="50" min="0" max="99">
                    </div>
                    <div class="form-group">
                        <label>INITIATIVE BONUS</label>
                        <input type="number" id="comb-init-bonus" value="0">
                    </div>
                </div>

                <h4 style="margin:15px 0 10px;font-size:12px;color:#888;border-bottom:1px solid var(--border-color);padding-bottom:5px;">COMBAT SKILLS</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>FIREARMS</label>
                        <input type="number" id="comb-firearms" value="20" min="0" max="99">
                    </div>
                    <div class="form-group">
                        <label>MELEE</label>
                        <input type="number" id="comb-melee" value="30" min="0" max="99">
                    </div>
                    <div class="form-group">
                        <label>UNARMED</label>
                        <input type="number" id="comb-unarmed" value="40" min="0" max="99">
                    </div>
                    <div class="form-group">
                        <label>DODGE</label>
                        <input type="number" id="comb-dodge" value="30" min="0" max="99">
                    </div>
                    <div class="form-group">
                        <label>ATHLETICS</label>
                        <input type="number" id="comb-athletics" value="30" min="0" max="99">
                    </div>
                    <div class="form-group">
                        <label>ALERTNESS</label>
                        <input type="number" id="comb-alertness" value="20" min="0" max="99">
                    </div>
                </div>

                <h4 style="margin:15px 0 10px;font-size:12px;color:#888;border-bottom:1px solid var(--border-color);padding-bottom:5px;">WEAPONS</h4>
                <div id="comb-weapons-list">
                    <!-- Weapon entries will be added here -->
                </div>
                <button type="button" onclick="addWeaponToForm()" style="margin-top:10px;">+ ADD WEAPON</button>

                <h4 style="margin:15px 0 10px;font-size:12px;color:#888;border-bottom:1px solid var(--border-color);padding-bottom:5px;">NOTES</h4>
                <div class="form-group">
                    <textarea id="comb-notes" rows="3" placeholder="Special abilities, conditions, etc..."></textarea>
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:15px;border-top:1px solid var(--border-color);">
                    <button type="button" onclick="closeCombatantModal()">CANCEL</button>
                    <button type="button" onclick="saveCombatant()" class="btn-success">SAVE COMBATANT</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template Manager Modal (Re-integrated from File 1) -->
    <div id="template-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>MANAGE TEMPLATES</h3>
            <div id="template-list-edit" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #333; padding: 5px;"></div>
            
            <div style="border-top: 1px solid #333; padding-top: 10px;">
                <h4>ADD/EDIT TEMPLATE</h4>
                <input type="hidden" id="temp-index">
                <input type="text" id="temp-name" placeholder="Name (e.g., Cultist)" style="width:100%; margin-bottom:5px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-bottom:5px;">
                    <input type="number" id="temp-hp" placeholder="HP">
                    <input type="number" id="temp-dex" placeholder="DEX">
                    <input type="number" id="temp-armor" placeholder="ARMOR">
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="saveTemplate()" class="btn-success" style="flex:1;">SAVE TEMPLATE</button>
                    <button onclick="clearTemplateForm()" style="flex:1;">CLEAR FORM</button>
                </div>
            </div>
            <button onclick="closeModal('template-modal')" style="width:100%; margin-top:10px;">CLOSE</button>
        </div>
    </div>
    
    <!-- Attack Modal -->
    <div id="attack-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2>‚öîÔ∏è ATTACK</h2>
                <button onclick="closeAttackModal()">‚úï CLOSE</button>
            </div>

            <div class="form-group">
                <label>ATTACKER</label>
                <input type="text" id="attack-attacker-name" readonly>
            </div>

            <div class="form-group">
                <label>SELECT TARGET</label>
                <select id="attack-target" style="width:100%;">
                    <option value="">-- Select Target --</option>
                </select>
            </div>

            <div class="form-group">
                <label>WEAPON</label>
                <select id="attack-weapon" style="width:100%;" onchange="updateAttackSkill()">
                    <option value="">-- Select Weapon --</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>BASE SKILL</label>
                    <input type="number" id="attack-skill" value="40" oninput="updateAttackFinalSkill()">
                </div>
                <div class="form-group">
                    <label>MODIFIERS</label>
                    <input type="number" id="attack-modifier" value="0" oninput="updateAttackFinalSkill()">
                </div>
                <div class="form-group">
                    <label>FINAL SKILL</label>
                    <input type="number" id="attack-final-skill" readonly>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="styled-checkbox" style="display:flex;align-items:center;gap:8px;margin-top:10px;">
                        <input type="checkbox" id="attack-aimed" onchange="updateAttackModifiers()">
                        <span style="color:var(--text-color);">AIMED (+20%)</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="styled-checkbox" style="display:flex;align-items:center;gap:8px;margin-top:10px;">
                        <input type="checkbox" id="attack-called" onchange="updateAttackModifiers()">
                        <span style="color:var(--text-color);">CALLED SHOT (-20%)</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>CALLED SHOT LOCATION</label>
                <select id="attack-location" style="width:100%;" disabled>
                    <option value="body">Body (Normal)</option>
                    <option value="head">Head (Bypass Helmet)</option>
                    <option value="limb">Limb (Disable)</option>
                    <option value="hand">Hand (Disarm)</option>
                    <option value="vitals">Vitals (Extra Damage)</option>
                </select>
            </div>

            <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
                <button onclick="executeAttack()" class="btn-danger btn-large">üé≤ ROLL ATTACK</button>
            </div>

            <div id="attack-result" class="hidden" style="margin-top:20px;padding:15px;background:rgba(0,0,0,0.4);border:1px solid var(--border-color);">
                <!-- Attack result will be shown here -->
            </div>
        </div>
    </div>

    <!-- Damage Modal -->
    <div id="damage-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:450px;">
            <div class="modal-header">
                <h2>üí• APPLY DAMAGE</h2>
                <button onclick="closeDamageModal()">‚úï CLOSE</button>
            </div>

            <div class="form-group">
                <label>TARGET</label>
                <select id="damage-target" style="width:100%;">
                    <option value="">-- Select Target --</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>DAMAGE DICE</label>
                    <input type="text" id="damage-dice" placeholder="e.g., 1d10+2">
                </div>
                <div class="form-group">
                    <label>OR FLAT DAMAGE</label>
                    <input type="number" id="damage-flat" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>LETHALITY %</label>
                    <input type="number" id="damage-lethality" min="0" max="100" placeholder="0">
                </div>
                <div class="form-group">
                    <label>ARMOR PIERCING</label>
                    <input type="number" id="damage-ap" min="0" value="0">
                </div>
            </div>

            <div class="form-group">
                <label class="styled-checkbox" style="display:flex;align-items:center;gap:8px;margin-top:10px;">
                    <input type="checkbox" id="damage-bypass-armor">
                    <span style="color:var(--text-color);">BYPASS ARMOR COMPLETELY</span>
                </label>
            </div>

            <div class="form-group">
                <label>DAMAGE TYPE</label>
                <select id="damage-type" style="width:100%;">
                    <option value="physical">Physical</option>
                    <option value="fire">Fire/Burn</option>
                    <option value="electric">Electric</option>
                    <option value="poison">Poison</option>
                    <option value="psychic">Psychic (WP)</option>
                    <option value="san">Sanity Loss</option>
                </select>
            </div>

            <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
                <button onclick="applyDamage()" class="btn-danger btn-large">üíÄ APPLY DAMAGE</button>
                <button onclick="applyHealing()" class="btn-success btn-large">üíö HEAL INSTEAD</button>
            </div>

            <div id="damage-result" class="hidden" style="margin-top:20px;">
                <!-- Damage result will be shown here -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è COMBAT SETTINGS</h2>
                <button onclick="closeSettingsModal()">‚úï CLOSE</button>
            </div>

            <h4 style="margin:0 0 15px;font-size:12px;color:#888;">PLAYER SHARING</h4>
            <div class="form-group">
                <label class="styled-checkbox" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="setting-player-view" onchange="togglePlayerSharing()">
                    <span style="color:var(--text-color);">ENABLE PLAYER VIEW (Share link below)</span>
                </label>
            </div>

            <div class="share-link-container" id="share-link-container" style="margin-bottom:20px;">
                <input type="text" id="share-link" readonly placeholder="Enable player view to generate link">
                <button onclick="copyShareLink()">COPY</button>
            </div>

            <h4 style="margin:15px 0;font-size:12px;color:#888;border-top:1px solid var(--border-color);padding-top:15px;">DISPLAY OPTIONS</h4>
            <div class="form-group">
                <label class="styled-checkbox" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="setting-show-enemy-hp" checked>
                    <span style="color:var(--text-color);">Show enemy HP to players</span>
                </label>
            </div>
            <div class="form-group">
                <label class="styled-checkbox" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="setting-show-enemy-stats">
                    <span style="color:var(--text-color);">Show enemy full stats to players</span>
                </label>
            </div>
            <div class="form-group">
                <!-- Changed to reflect the DEX-based sort/tiebreaker preference -->
                <label class="styled-checkbox" style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="setting-use-dex-sort" checked>
                    <span style="color:var(--text-color);">Use DEX-based Sort (vs. 1d10 roll)</span>
                </label>
            </div>

            <h4 style="margin:15px 0;font-size:12px;color:#888;border-top:1px solid var(--border-color);padding-top:15px;">THEME</h4>
            <div class="form-row">
                <button onclick="setTheme('dark')" id="theme-dark-btn" class="active">DARK</button>
                <button onclick="setTheme('terminal')" id="theme-terminal-btn">TERMINAL</button>
                <button onclick="setTheme('crimson')" id="theme-crimson-btn">CRIMSON</button>
                <button onclick="setTheme('light')" id="theme-light-btn">LIGHT</button>
            </div>

            <div style="margin-top:20px;padding-top:15px;border-top:1px solid var(--border-color);">
                <button onclick="closeSettingsModal()" class="btn-primary" style="width:100%;">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- Custom Roll Modal -->
    <div id="custom-roll-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h2>üé≤ CUSTOM ROLL</h2>
                <button onclick="closeCustomRollModal()">‚úï CLOSE</button>
            </div>

            <div class="form-group">
                <label>DICE EXPRESSION</label>
                <input type="text" id="custom-dice-expr" placeholder="e.g., 2d6+5, 1d20-2, 4d6kh3">
            </div>

            <div class="form-group">
                <label>ROLL LABEL (OPTIONAL)</label>
                <input type="text" id="custom-roll-label" placeholder="e.g., Damage, Initiative">
            </div>

            <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
                <button onclick="executeCustomRoll()" class="btn-primary btn-large">üé≤ ROLL</button>
            </div>
        </div>
    </div>

    <!-- Status Effect Modal -->
    <div id="status-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h2>ADD STATUS EFFECT</h2>
                <button onclick="closeStatusModal()">‚úï CLOSE</button>
            </div>

            <div class="form-group">
                <label>TARGET</label>
                <select id="status-target" style="width:100%;">
                    <option value="">-- Select Target --</option>
                </select>
            </div>

            <div class="form-group">
                <label>STATUS EFFECT</label>
                <select id="status-type" style="width:100%;">
                    <optgroup label="Negative">
                        <option value="prone|negative">Prone</option>
                        <option value="stunned|negative">Stunned</option>
                        <option value="blinded|negative">Blinded</option>
                        <option value="deafened|negative">Deafened</option>
                        <option value="bleeding|negative">Bleeding</option>
                        <option value="burning|negative">Burning</option>
                        <option value="poisoned|negative">Poisoned</option>
                        <option value="pinned|negative">Pinned</option>
                        <option value="grappled|negative">Grappled</option>
                        <option value="unconscious|negative">Unconscious</option>
                        <option value="dying|negative">Dying</option>
                        <option value="panicked|negative">Panicked</option>
                        <option value="exhausted|negative">Exhausted</option>
                    </optgroup>
                    <optgroup label="Positive">
                        <option value="aimed|positive">Aimed</option>
                        <option value="cover|positive">In Cover</option>
                        <option value="concealed|positive">Concealed</option>
                        <option value="inspired|positive">Inspired</option>
                    </optgroup>
                    <optgroup label="Neutral">
                        <option value="delayed|neutral">Delayed</option>
                        <option value="reloading|neutral">Reloading</option>
                        <option value="concentrating|neutral">Concentrating</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label>DURATION (ROUNDS, 0 = INDEFINITE)</label>
                <input type="number" id="status-duration" value="0" min="0">
            </div>

            <div class="form-group">
                <label>CUSTOM STATUS (OPTIONAL)</label>
                <input type="text" id="status-custom" placeholder="Custom status name...">
            </div>

            <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
                <button onclick="applyStatus()" class="btn-warning btn-large">APPLY STATUS</button>
            </div>
        </div>
    </div>
    <script>
        // ============================================================
        // FIREBASE CONFIGURATION
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAfSyEavpC2piXdYOQTdkj8DV--djZWJWM", // User placeholder
            authDomain: "afraidofthedark-83b3c.firebaseapp.com",
            databaseURL: "https://afraidofthedark-83b3c-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "afraidofthedark-83b3c",
            storageBucket: "afraidofthedark-83b3c.firebasestorage.app",
            messagingSenderId: "63737248707",
            appId: "1:63737248707:web:4da1fa983dc8beb3acdb76"
        };
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";

        // ============================================================
        // STATE MANAGEMENT
        // ============================================================
        const ADMIN_PASSWORD_HASH = 'dmFsa3lyaWU='; // Base64 for "valkyrie"
        let isAdmin = false;
        let isPlayerMode = false;
        let db = null;
        let combatSessionId = null;
        let playerName = "Anonymous";

        // Combat State
        let combatState = {
            round: 1,
            phase: 'setup', // setup, active, ended
            activeIndex: -1,
            combatants: [],
            log: [],
            settings: {
                playerViewEnabled: false,
                showEnemyHp: true,
                showEnemyStats: false,
                useDexSort: true // New setting based on File 1 preference
            }
        };

        // Templates (From File 1 - mutable via UI and localStorage)
        let templates = [
            { name: "Cultist", hp: 10, dex: 10, armor: 0 },
            { name: "Deep One", hp: 16, dex: 12, armor: 2 },
            { name: "Soldier", hp: 13, dex: 11, armor: 4 }
        ];


        // ============================================================
        // INITIALIZATION & LOGIN (Integrated from File 1)
        // ============================================================
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionParam = urlParams.get('session');
            const modeParam = urlParams.get('mode');

            if (sessionParam) {
                combatSessionId = sessionParam;
                if (modeParam === 'player') {
                    isPlayerMode = true;
                    document.body.classList.add('player-mode');
                    document.getElementById('login-title').textContent = "AGENT ACCESS";
                    document.getElementById('login-message').textContent = "ENTER IDENTITY";
                    document.getElementById('login-input').placeholder = "AGENT NAME";
                    document.getElementById('login-input').type = "text";
                }
            } else {
                combatSessionId = `combat_${Date.now()}`;
            }

            // Load Templates and Settings
            const savedTemps = localStorage.getItem('aotd_templates');
            if(savedTemps) templates = JSON.parse(savedTemps);
            loadSettings();
            
            // Show login screen first
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-input').focus();
        };

        function handleLoginKey(e) {
            if(e.key === 'Enter') attemptLogin();
        }

        function attemptLogin() {
            const input = document.getElementById('login-input').value;
            
            if (isPlayerMode) {
                if(!input.trim()) { alert("Identity required."); return; }
                playerName = input.trim();
                document.getElementById('user-display').textContent = `AGENT: ${playerName.toUpperCase()}`;
                startApp();
            } else {
                if (btoa(input) === ADMIN_PASSWORD_HASH) {
                    isAdmin = true;
                    document.getElementById('user-display').textContent = "SYSTEM: ADMIN";
                    document.getElementById('admin-logout-btn').classList.remove('hidden');
                    startApp();
                } else {
                    alert("ACCESS DENIED");
                    // Do not redirect, just hide loading overlay to keep login visible
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            }
        }

        async function startApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            if (isFirebaseConfigured) {
                await initFirebase();
            } else {
                console.warn('Firebase not configured. Using local mode.');
                loadLocalState();
                hideLoading();
                updateConnectionStatus('disconnected');
            }

            setupEventListeners();
        }


        async function initFirebase() {
            try {
                updateConnectionStatus('connecting');
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();

                // Connection monitoring
                db.ref('.info/connected').on('value', (snap) => {
                    if (snap.val()) {
                        updateConnectionStatus('connected');
                    } else {
                        updateConnectionStatus('disconnected');
                    }
                });

                // Listen for combat state changes
                db.ref(`combatSessions/${combatSessionId}`).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Merge saved state into current state
                        combatState = { ...combatState, ...data }; 
                    }
                    renderAll();
                    hideLoading();
                });

            } catch (error) {
                console.error('Firebase error:', error);
                loadLocalState();
                hideLoading();
                updateConnectionStatus('disconnected');
            }
        }

        function loadLocalState() {
            const saved = localStorage.getItem(`aotd_combat_${combatSessionId}`);
            if (saved) {
                combatState = JSON.parse(saved);
            }
            renderAll();
        }

        function saveState() {
            localStorage.setItem(`aotd_combat_${combatSessionId}`, JSON.stringify(combatState));

            if (isFirebaseConfigured && db && isAdmin) {
                db.ref(`combatSessions/${combatSessionId}`).set(combatState).catch(err => {
                    console.error('Firebase save error:', err);
                });
            }
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function updateConnectionStatus(status) {
            const badge = document.getElementById('connection-badge');
            badge.className = `connection-badge ${status}`;
            const texts = {
                connected: 'CONNECTED',
                disconnected: 'OFFLINE',
                connecting: 'CONNECTING'
            };
            badge.querySelector('span:last-child').textContent = texts[status] || status.toUpperCase();
        }

        function setupEventListeners() {
            const attackSkillInput = document.getElementById('attack-skill');
            const attackModifierInput = document.getElementById('attack-modifier');
            if (attackSkillInput) attackSkillInput.addEventListener('input', updateAttackFinalSkill);
            if (attackModifierInput) attackModifierInput.addEventListener('input', updateAttackFinalSkill);

            document.addEventListener('keydown', (e) => {
                if (!isAdmin) return;
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                switch (e.key) {
                    case 'n':
                    case 'N':
                        if (combatState.phase === 'active') nextTurn();
                        break;
                    case 'r':
                    case 'R':
                        if (e.ctrlKey || e.metaKey) return; 
                        rollDice('1d100');
                        break;
                    case 'Escape':
                        closeAllModals();
                        break;
                }
            });
        }
        
        // ============================================================
        // TEMPLATE MANAGEMENT (From File 1 - Integrated)
        // ============================================================
        function renderTemplates() {
            const container = document.getElementById('enemy-templates');
            container.innerHTML = templates.map((t, idx) => `
                <button class="template-btn" onclick="addFromTemplate(${idx})">
                    <span class="template-name">${t.name}</span>
                    <span class="template-stats">HP:${t.hp} DEX:${t.dex}</span>
                </button>
            `).join('');
            
            // Render list for Modal
            const editList = document.getElementById('template-list-edit');
            if (editList) { // Check if the modal element exists
                editList.innerHTML = templates.map((t, idx) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; background:#1a1a1a; padding:5px; margin-bottom:2px;">
                        <span>${t.name}</span>
                        <div>
                            <button onclick="loadTemplateToForm(${idx})" style="font-size:9px;">EDIT</button>
                            <button onclick="deleteTemplate(${idx})" class="btn-danger" style="font-size:9px;">X</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function openTemplateManager() {
            if (!isAdmin) return;
            document.getElementById('template-modal').classList.remove('hidden');
            renderTemplates();
        }

        function saveTemplate() {
            if (!isAdmin) return;
            const name = document.getElementById('temp-name').value;
            if(!name) return;

            const newTemp = {
                name: name,
                hp: parseInt(document.getElementById('temp-hp').value) || 10,
                dex: parseInt(document.getElementById('temp-dex').value) || 10,
                armor: parseInt(document.getElementById('temp-armor').value) || 0,
                // New attributes need default values if not in old template structure
                str: 10, con: 10, int: 10, pow: 10, cha: 10, firearms: 20, melee: 30, unarmed: 40, dodge: 30, athletics: 30, alertness: 20, weapons: []
            };
            // Preserve existing properties if editing an old, fully-featured template
            const idxStr = document.getElementById('temp-index').value;
            if(idxStr) {
                 const idx = parseInt(idxStr);
                 templates[idx] = { ...templates[idx], ...newTemp };
            } else {
                templates.push(newTemp);
            }
            
            localStorage.setItem('aotd_templates', JSON.stringify(templates));
            clearTemplateForm();
            renderTemplates();
        }

        function deleteTemplate(idx) {
            if (!isAdmin) return;
            if(!confirm("Delete template?")) return;
            templates.splice(idx, 1);
            localStorage.setItem('aotd_templates', JSON.stringify(templates));
            renderTemplates();
        }

        function loadTemplateToForm(idx) {
            if (!isAdmin) return;
            const t = templates[idx];
            document.getElementById('temp-index').value = idx;
            document.getElementById('temp-name').value = t.name;
            document.getElementById('temp-hp').value = t.hp;
            document.getElementById('temp-dex').value = t.dex;
            document.getElementById('temp-armor').value = t.armor;
        }

        function clearTemplateForm() {
            if (!isAdmin) return;
            document.getElementById('temp-index').value = "";
            document.getElementById('temp-name').value = "";
            document.getElementById('temp-hp').value = "";
            document.getElementById('temp-dex').value = "";
            document.getElementById('temp-armor').value = "";
        }

        function addFromTemplate(idx) {
            // This function is still needed to create a full combatant object
            const t = templates[idx];
            const name = prompt("Name for this enemy?", t.name);
            if(!name) return;
            
            const newCombatant = {
                id: generateId(),
                name: name,
                type: 'enemy',
                str: t.str || 10, dex: t.dex || 10, con: t.con || 10, int: t.int || 10, pow: t.pow || 10, cha: t.cha || 10,
                hp: t.hp, hpMax: t.hp,
                wp: t.pow || 10, wpMax: t.pow || 10,
                san: 0, sanMax: 99,
                armor: t.armor || 0,
                initBonus: 0,
                initiative: (t.dex || 10) + (Math.random() * 20), // Use DEX + random tiebreaker
                tieBreaker: Math.random(), // For consistent DEX sorting
                firearms: t.firearms || 20, melee: t.melee || 30, unarmed: t.unarmed || 40, dodge: t.dodge || 30, athletics: t.athletics || 30, alertness: t.alertness || 20,
                weapons: JSON.parse(JSON.stringify(t.weapons || [])),
                statuses: [],
                notes: '',
                isVisible: true
            };
            
            combatState.combatants.push(newCombatant);
            addLogEntry('system', `<span class="log-actor">${newCombatant.name}</span> entered combat.`);
            saveState();
            renderAll();
        }


        // ============================================================
        // THEME & SETTINGS
        // ============================================================
        function setTheme(theme) {
            const themes = ['dark', 'terminal', 'crimson', 'light', 'highcontrast'];
            themes.forEach(t => document.body.classList.remove(`theme-${t}`));
            document.body.classList.add(`theme-${theme}`);

            document.querySelectorAll('[id^="theme-"][id$="-btn"]').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById(`theme-${theme}-btn`);
            if (btn) btn.classList.add('active');

            localStorage.setItem('aotd_combat_theme', theme);
        }

        function loadSettings() {
            const theme = localStorage.getItem('aotd_combat_theme') || 'dark';
            setTheme(theme);
            
            // Load custom settings from localStorage or defaults
            const savedSettings = JSON.parse(localStorage.getItem('aotd_settings') || '{}');
            combatState.settings = { ...combatState.settings, ...savedSettings };
        }

        // ============================================================
        // ADMIN MODE
        // ============================================================
        function toggleAdminMode() {
            if (isAdmin) {
                isAdmin = false;
                document.body.classList.remove('admin-mode');
                document.getElementById('user-display').textContent = "";
                document.getElementById('admin-logout-btn').classList.add('hidden');
                alert('Admin mode deactivated. Restarting as Player mode.');
                window.location.reload(); // Force reload to go back to login screen
            }
        }

        // ============================================================
        // RENDERING
        // ============================================================
        function renderAll() {
            renderInitiativeList();
            renderCombatantGrid();
            renderCombatLog();
            updateCombatStatusBar();
            updateActionPanel();
            renderTemplates(); // Rerender templates on state change
            if (isPlayerMode) {
                applyPlayerModeRestrictions();
            }
        }

        function renderInitiativeList() {
            const container = document.getElementById('initiative-list');

            if (combatState.combatants.length === 0) {
                container.innerHTML = '<div class="empty-state" style="text-align:center;padding:20px;color:#555;">No combatants added</div>';
                return;
            }

            // Determine sort order: By initiative value OR by DEX/tiebreaker (File 1 logic)
            const isDexSort = combatState.settings.useDexSort || combatState.phase === 'setup';
            
            const sorted = [...combatState.combatants]
                .map((c, i) => ({ ...c, originalIndex: i }))
                .sort((a, b) => {
                    if (isDexSort) {
                        // DEX Sort (File 1 Logic)
                        if (b.dex !== a.dex) return b.dex - a.dex;
                        return (b.tieBreaker || 0) - (a.tieBreaker || 0);
                    } else {
                        // Rolled Initiative Sort (File 2 Logic)
                        return (b.initiative || 0) - (a.initiative || 0);
                    }
                });

            // Update Initiative Button Text
            const initBtn = document.getElementById('init-sort-btn');
            if (initBtn) {
                 initBtn.textContent = isDexSort ? 'SORT (DEX)' : 'ROLL ALL';
                 initBtn.onclick = isDexSort ? sortInitiative : rollAllInitiative;
            }


            container.innerHTML = sorted.map((c, order) => {
                const isActive = c.originalIndex === combatState.activeIndex;
                const isDead = c.hp <= 0;
                const isDelayed = c.statuses?.some(s => s.name === 'delayed');
                
                const initValue = isDexSort ? c.dex : (c.initiative || '-');

                return `
                    <div class="initiative-item ${isActive ? 'active' : ''} ${isDead ? 'dead' : ''} ${isDelayed ? 'delayed' : ''}" onclick="selectCombatant(${c.originalIndex})" data-index="${c.originalIndex}">
                        <div class="init-order">${order + 1}</div>
                        <div class="init-type-indicator ${c.type}"></div>
                        <div class="init-info">
                            <div class="init-name">${escapeHtml(c.name)}</div>
                            <div class="init-stats">
                                <span>HP: ${c.hp}/${c.hpMax}</span>
                                <span>DEX: ${c.dex}</span>
                            </div>
                        </div>
                        <div class="init-value">${initValue}</div>
                        <div class="init-actions admin-only">
                            <!-- Only show roll button if not in DEX sort mode -->
                            <button onclick="event.stopPropagation();rollInitiativeFor(${c.originalIndex})" ${isDexSort ? 'style="display:none;"' : ''}>üé≤</button>
                            <button onclick="event.stopPropagation();setActiveByIndex(${c.originalIndex})" class="btn-primary">‚ñ∂</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ... (rest of render functions remain the same as File 2, using the settings logic) ...
        
        function renderCombatantGrid() {
            const container = document.getElementById('combatant-grid');

            if (combatState.combatants.length === 0) {
                container.innerHTML = `
                    <div style="grid-column:1/-1;text-align:center;padding:60px;color:#555;">
                        <h3 style="margin-bottom:10px;">NO COMBATANTS</h3>
                        <p>Add players and enemies to begin combat.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = combatState.combatants.map((c, index) => {
                const isActive = index === combatState.activeIndex;
                const isDead = c.hp <= 0;
                const hpPercent = Math.max(0, Math.min(100, (c.hp / c.hpMax) * 100));
                const wpPercent = Math.max(0, Math.min(100, (c.wp / c.wpMax) * 100));
                const hpClass = hpPercent <= 25 ? 'critical' : hpPercent <= 50 ? 'wounded' : '';

                const showEnemyHp = combatState.settings.showEnemyHp || c.type !== 'enemy' || isAdmin;
                const showEnemyStats = combatState.settings.showEnemyStats || c.type !== 'enemy' || isAdmin;
                const showHpBar = showEnemyHp || c.type !== 'enemy'; 

                return `
                    <div class="combatant-card ${c.type} ${isActive ? 'active' : ''} ${isDead ? 'dead' : ''}" data-index="${index}" data-owner="${c.type}">
                        <div class="card-header">
                            <div class="card-name">
                                <input type="text" value="${escapeHtml(c.name)}" onchange="updateCombatantName(${index}, this.value)" ${isAdmin ? '' : 'readonly'}>
                            </div>
                            <span class="card-type-badge ${c.type}">${c.type.toUpperCase()}</span>
                        </div>
                        <div class="card-body">
                            <!-- Status Effects -->
                            ${c.statuses && c.statuses.length > 0 ? `
                                <div class="status-effects">
                                    ${c.statuses.map(s => `
                                        <span class="status-tag ${s.type}">
                                            ${s.name}${s.duration > 0 ? ` (${s.duration})` : ''}
                                            <span class="remove-status admin-only" onclick="removeStatus(${index}, '${s.name}')">√ó</span>
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <!-- Stat Bars -->
                            <div class="stat-bars">
                                <div class="stat-bar-container" ${!showHpBar ? 'style="display:none;"' : ''}>
                                    <div class="stat-bar-header">
                                        <span class="label">HP</span>
                                        <span class="value">${showEnemyHp ? `${c.hp}/${c.hpMax}` : c.type === 'enemy' ? '???' : `${c.hp}/${c.hpMax}`}</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div class="stat-bar-fill hp ${hpClass}" style="width:${hpPercent}%"></div>
                                    </div>
                                    <div class="stat-inputs admin-only">
                                        <input type="number" value="${c.hp}" min="0" onchange="updateCombatantStat(${index}, 'hp', this.value)" class="small">
                                        <span>/</span>
                                        <input type="number" value="${c.hpMax}" min="1" onchange="updateCombatantStat(${index}, 'hpMax', this.value)" class="small">
                                    </div>
                                </div>
                                <div class="stat-bar-container" ${c.type === 'enemy' ? 'style="display:none;"' : ''}>
                                    <div class="stat-bar-header">
                                        <span class="label">WP</span>
                                        <span class="value">${c.wp}/${c.wpMax}</span>
                                    </div>
                                    <div class="stat-bar">
                                        <div class="stat-bar-fill wp" style="width:${wpPercent}%"></div>
                                    </div>
                                    <div class="stat-inputs admin-only">
                                        <input type="number" value="${c.wp}" min="0" onchange="updateCombatantStat(${index}, 'wp', this.value)" class="small">
                                        <span>/</span>
                                        <input type="number" value="${c.wpMax}" min="1" onchange="updateCombatantStat(${index}, 'wpMax', this.value)" class="small">
                                    </div>
                                </div>
                            </div>
                            <!-- Armor -->
                            ${c.armor > 0 ? `
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:5px;background:rgba(255,255,255,0.05);border:1px solid var(--border-color);">
                                    <span style="font-size:11px;color:#888;">ARMOR:</span>
                                    <input type="number" value="${c.armor}" min="0" style="width:40px;" class="admin-only" onchange="updateCombatantStat(${index}, 'armor', this.value)">
                                    <span class="player-visible" style="font-weight:bold;">${c.armor} AP</span>
                                </div>
                            ` : ''}
                            <!-- Attributes (Hidden for enemy in Player Mode if setting is off) -->
                            <div class="attributes-grid" ${c.type === 'enemy' && !showEnemyStats ? 'style="display:none;"' : ''}>
                                ${['str','dex','con','int','pow','cha'].map(attr => `
                                    <div class="attr-item">
                                        <div class="attr-label">${attr.toUpperCase()}</div>
                                        <div class="attr-value">${c[attr]}</div>
                                        <div class="attr-x5">√ó5: ${c[attr] * 5}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <!-- Skills (Hidden for enemy in Player Mode if setting is off) -->
                            <div class="skills-section" ${c.type === 'enemy' && !showEnemyStats ? 'style="display:none;"' : ''}>
                                <div class="skills-compact">
                                    <span class="skill-tag">Firearms: <span class="skill-value">${c.firearms}%</span></span>
                                    <span class="skill-tag">Melee: <span class="skill-value">${c.melee}%</span></span>
                                    <span class="skill-tag">Unarmed: <span class="skill-value">${c.unarmed}%</span></span>
                                    <span class="skill-tag">Dodge: <span class="skill-value">${c.dodge}%</span></span>
                                </div>
                            </div>
                            <!-- Weapons -->
                            ${c.weapons && c.weapons.length > 0 ? `
                                <div class="weapons-section">
                                    ${c.weapons.map((w, wi) => `
                                        <div class="weapon-item">
                                            <span class="weapon-name">${escapeHtml(w.name)}</span>
                                            <span class="weapon-stat">Skill: <strong>${w.skill}%</strong></span>
                                            <span class="weapon-stat">Dmg: <strong>${w.dmg}</strong></span>
                                            ${w.lethality ? `<span class="weapon-stat">Leth: <strong>${w.lethality}%</strong></span>` : ''}
                                            ${w.ammo !== null && w.ammo !== undefined ? `<span class="weapon-stat">Ammo: <strong>${w.ammo}</strong></span>` : ''}
                                            <div class="weapon-actions admin-only">
                                                <button onclick="quickAttackWith(${index}, ${wi})" class="btn-danger">ATK</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <!-- Card Actions -->
                            <div class="card-actions admin-only">
                                <button onclick="openAttackModalFor(${index})" class="btn-danger">‚öîÔ∏è ATTACK</button>
                                <button onclick="openDamageModalFor(${index})" class="btn-warning">üí• DAMAGE</button>
                                <button onclick="openStatusModalFor(${index})">üìã STATUS</button>
                                <button onclick="openEditCombatantModal(${index})">‚úèÔ∏è EDIT</button>
                                <button onclick="removeCombatant(${index})" class="btn-danger">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateCombatStatusBar() {
            document.getElementById('round-counter').textContent = combatState.round;
            document.getElementById('combat-phase').textContent = combatState.phase.toUpperCase();
            const activeC = combatState.combatants[combatState.activeIndex];
            document.getElementById('active-combatant-name').textContent = activeC ? activeC.name : '---';

            const startBtn = document.getElementById('start-combat-btn');
            const nextBtn = document.getElementById('next-turn-btn');
            const prevBtn = document.getElementById('prev-turn-btn');

            if (combatState.phase === 'active') {
                if(startBtn) startBtn.disabled = true;
                if(nextBtn) nextBtn.disabled = false;
                if(prevBtn) prevBtn.disabled = combatState.activeIndex <= 0;
            } else {
                if(startBtn) startBtn.disabled = combatState.combatants.length === 0;
                if(nextBtn) nextBtn.disabled = true;
                if(prevBtn) prevBtn.disabled = true;
            }
        }
        
        function updateActionPanel() {
            const panel = document.getElementById('action-panel');
            const activeC = combatState.combatants[combatState.activeIndex];

            if (activeC && combatState.phase === 'active') {
                document.getElementById('action-panel-name').textContent = activeC.name;
                document.getElementById('action-panel-type').textContent = activeC.type.toUpperCase();
                document.getElementById('action-panel-type').className = `card-type-badge ${activeC.type}`;
                
                // Show only if Admin or Player's turn
                if (isAdmin || (isPlayerMode && canPlayerControl(combatState.activeIndex))) {
                    panel.style.display = 'block';
                } else {
                    panel.style.display = 'none';
                }
            } else {
                panel.style.display = 'none';
            }
        }
        
        // ============================================================
        // COMBAT MANAGEMENT
        // ============================================================
        function startCombat() {
            if (!isAdmin) return;
            if (combatState.combatants.length === 0) {
                alert('Add combatants first!');
                return;
            }
            
            // Auto-sort/roll initiative based on setting
            if (combatState.settings.useDexSort) {
                sortInitiative(); // This is the DEX sort
            } else {
                rollAllInitiative(); // This is the 1d10 roll
            }

            combatState.phase = 'active';
            combatState.round = 1;

            // Sort logic is handled in renderInitiativeList, we just need the first index from the sorted array.
            const sorted = [...combatState.combatants]
                .map((c, i) => ({ ...c, originalIndex: i }))
                .sort((a, b) => {
                    if (combatState.settings.useDexSort) {
                        if (b.dex !== a.dex) return b.dex - a.dex;
                        return (b.tieBreaker || 0) - (a.tieBreaker || 0);
                    } else {
                        return (b.initiative || 0) - (a.initiative || 0);
                    }
                });

            let firstIndex = sorted.length > 0 ? sorted[0].originalIndex : -1;

            combatState.activeIndex = firstIndex;

            addLogEntry('system', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMBAT STARTED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            addLogEntry('round-marker', `‚îÅ‚îÅ‚îÅ ROUND ${combatState.round} ‚îÅ‚îÅ‚îÅ`);
            if (firstIndex !== -1) {
                const first = combatState.combatants[firstIndex];
                addLogEntry('system', `<span class="log-actor">${first.name}</span> acts first!`);
            }

            saveState();
            renderAll();
        }

        function nextTurn() {
            if (!isAdmin) return;
            if (combatState.phase !== 'active') return;

            // Get sorted combatants based on current setting
            const isDexSort = combatState.settings.useDexSort;
            
            const sorted = combatState.combatants
                .map((c, i) => ({ ...c, originalIndex: i }))
                .filter(c => c.hp > 0)
                .sort((a, b) => {
                    if (isDexSort) {
                        if (b.dex !== a.dex) return b.dex - a.dex;
                        return (b.tieBreaker || 0) - (a.tieBreaker || 0);
                    } else {
                        return (b.initiative || 0) - (a.initiative || 0);
                    }
                });


            // Find current position in order
            const currentPos = sorted.findIndex(c => c.originalIndex === combatState.activeIndex);

            // Move to next
            let nextPos = currentPos + 1;

            // Check if we need a new round
            if (nextPos >= sorted.length) {
                newRound();
                return;
            }

            combatState.activeIndex = sorted[nextPos].originalIndex;
            const next = combatState.combatants[combatState.activeIndex];
            addLogEntry('system', `<span class="log-actor">${next.name}</span>'s turn.`);

            // Tick down status durations
            tickStatusDurations(combatState.activeIndex);

            saveState();
            renderAll();
        }
        
        function previousTurn() {
            if (!isAdmin) return;
            const isDexSort = combatState.settings.useDexSort;
            
            const sorted = combatState.combatants
                .map((c, i) => ({ ...c, originalIndex: i }))
                .filter(c => c.hp > 0)
                .sort((a, b) => {
                    if (isDexSort) {
                        if (b.dex !== a.dex) return b.dex - a.dex;
                        return (b.tieBreaker || 0) - (a.tieBreaker || 0);
                    } else {
                        return (b.initiative || 0) - (a.initiative || 0);
                    }
                });

            const currentPos = sorted.findIndex(c => c.originalIndex === combatState.activeIndex);

            if (currentPos > 0) {
                combatState.activeIndex = sorted[currentPos - 1].originalIndex;
                saveState();
                renderAll();
            }
        }
        
        function newRound() {
            if (!isAdmin) return;
            combatState.round++;

            const isDexSort = combatState.settings.useDexSort;

            const sorted = combatState.combatants
                .map((c, i) => ({ ...c, originalIndex: i }))
                .filter(c => c.hp > 0)
                .sort((a, b) => {
                    if (isDexSort) {
                        if (b.dex !== a.dex) return b.dex - a.dex;
                        return (b.tieBreaker || 0) - (a.tieBreaker || 0);
                    } else {
                        return (b.initiative || 0) - (a.initiative || 0);
                    }
                });

            if (sorted.length > 0) {
                combatState.activeIndex = sorted[0].originalIndex;
            }

            addLogEntry('round-marker', `‚îÅ‚îÅ‚îÅ ROUND ${combatState.round} ‚îÅ‚îÅ‚îÅ`);
            if (sorted.length > 0) {
                addLogEntry('system', `<span class="log-actor">${sorted[0].name}</span> acts first.`);
            }

            saveState();
            renderAll();
        }

        function endCombat() {
            if (!isAdmin) return;
            if (!confirm('End combat? This will reset the encounter.')) return;

            combatState.phase = 'ended';
            addLogEntry('system', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMBAT ENDED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            saveState();
            renderAll();
        }

        // ============================================================
        // INITIATIVE (Modified for File 1 logic preference)
        // ============================================================
        
        // This function implements File 1's DEX-based sorting
        function sortInitiative() {
            if (!isAdmin) return;
             // Forces a rerender using the DEX-based sort logic, but doesn't change `initiative` values
            addLogEntry("system", "Initiative sorted by DEX (Tiebreaker).");
            saveState();
            renderAll(); // The sorting logic is entirely within renderInitiativeList now
        }


        // This function is the File 2's roll logic (1d10 + DEX/2 + Bonus)
        function rollAllInitiative() {
            if (!isAdmin) return;
            combatState.combatants.forEach((c, i) => {
                // Ensure tieBreaker is present for DEX-sort fallback
                if (c.tieBreaker === undefined || c.tieBreaker === null) {
                    c.tieBreaker = Math.random();
                }

                // Standard roll logic
                const dexMod = Math.floor((c.dex || 10) / 2); 
                const roll = Math.floor(Math.random() * 10) + 1; // 1d10
                c.initiative = roll + dexMod + (c.initBonus || 0);

                // Add tiebreaker to initiative roll to break ties between equal initiative rolls (File 2 Enhancement)
                c.initiative += (c.tieBreaker * 0.01); 
            });
            addLogEntry('system', 'All combatants rolled Initiative (1d10 + DEX/2 + Bonus)!');
            saveState();
            renderAll();
        }

        function rollInitiativeFor(index, silent = false) {
            if (!isAdmin) return;

            const c = combatState.combatants[index];
            const dexMod = Math.floor((c.dex || 10) / 2);
            const roll = Math.floor(Math.random() * 10) + 1; // 1d10
            
            // Ensure tieBreaker is present for DEX-sort fallback
            if (c.tieBreaker === undefined || c.tieBreaker === null) {
                c.tieBreaker = Math.random();
            }
            
            c.initiative = roll + dexMod + (c.initBonus || 0) + (c.tieBreaker * 0.01);

            if (!silent) {
                addLogEntry('move', `<span class="log-actor">${c.name}</span> rolled initiative: <span class="log-roll">${Math.floor(c.initiative)}</span> (${roll} + DEX ${dexMod} + Bonus ${c.initBonus || 0})`);
                saveState();
                renderAll();
            }
        }
        
        function selectCombatant(index) {
            const card = document.querySelector(`.combatant-card[data-index="${index}"]`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.style.animation = 'pulse 0.5s';
                setTimeout(() => card.style.animation = '', 500);
            }
        }

        function setActiveByIndex(index) {
            if (!isAdmin) return;
            const c = combatState.combatants[index];
            if (c && c.hp > 0) {
                combatState.activeIndex = index;
                addLogEntry('system', `Active combatant set to <span class="log-actor">${c.name}</span>`);
                saveState();
                renderAll();
            }
        }
        
        // ... (rest of File 2 logic for combatant management, attack, damage, etc.) ...

        // ============================================================
        // COMBATANT MANAGEMENT
        // ============================================================

        function generateId() {
            return 'comb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function openAddCombatantModal(type = 'player') {
            if (!isAdmin) return;

            document.getElementById('combatant-modal-title').textContent = `ADD ${type.toUpperCase()}`;
            document.getElementById('combatant-id').value = '';
            document.getElementById('comb-name').value = type === 'player' ? 'New Agent' : 'New Enemy';
            document.getElementById('comb-type').value = type;

            document.getElementById('comb-str').value = 10;
            document.getElementById('comb-dex').value = 10;
            document.getElementById('comb-con').value = 10;
            document.getElementById('comb-int').value = 10;
            document.getElementById('comb-pow').value = 10;
            document.getElementById('comb-cha').value = 10;
            document.getElementById('comb-hp').value = 10;
            document.getElementById('comb-hp-max').value = 10;
            document.getElementById('comb-wp').value = 10;
            document.getElementById('comb-wp-max').value = 10;
            document.getElementById('comb-armor').value = 0;
            document.getElementById('comb-san').value = 50;
            document.getElementById('comb-init-bonus').value = 0;
            document.getElementById('comb-firearms').value = 20;
            document.getElementById('comb-melee').value = 30;
            document.getElementById('comb-unarmed').value = 40;
            document.getElementById('comb-dodge').value = 30;
            document.getElementById('comb-athletics').value = 30;
            document.getElementById('comb-alertness').value = 20;
            document.getElementById('comb-notes').value = '';

            document.getElementById('comb-weapons-list').innerHTML = '';

            document.getElementById('combatant-modal').classList.remove('hidden');
        }

        function openEditCombatantModal(index) {
            if (!isAdmin) return;

            const c = combatState.combatants[index];
            if (!c) return;

            document.getElementById('combatant-modal-title').textContent = 'EDIT COMBATANT';
            document.getElementById('combatant-id').value = index;
            document.getElementById('comb-name').value = c.name;
            document.getElementById('comb-type').value = c.type;
            document.getElementById('comb-str').value = c.str;
            document.getElementById('comb-dex').value = c.dex;
            document.getElementById('comb-con').value = c.con;
            document.getElementById('comb-int').value = c.int;
            document.getElementById('comb-pow').value = c.pow;
            document.getElementById('comb-cha').value = c.cha;
            document.getElementById('comb-hp').value = c.hp;
            document.getElementById('comb-hp-max').value = c.hpMax;
            document.getElementById('comb-wp').value = c.wp;
            document.getElementById('comb-wp-max').value = c.wpMax;
            document.getElementById('comb-armor').value = c.armor;
            document.getElementById('comb-san').value = c.san || 50;
            document.getElementById('comb-init-bonus').value = c.initBonus || 0;
            document.getElementById('comb-firearms').value = c.firearms;
            document.getElementById('comb-melee').value = c.melee;
            document.getElementById('comb-unarmed').value = c.unarmed;
            document.getElementById('comb-dodge').value = c.dodge;
            document.getElementById('comb-athletics').value = c.athletics || 30;
            document.getElementById('comb-alertness').value = c.alertness || 20;
            document.getElementById('comb-notes').value = c.notes || '';

            const weaponsList = document.getElementById('comb-weapons-list');
            weaponsList.innerHTML = '';
            if (c.weapons && c.weapons.length > 0) {
                c.weapons.forEach(w => addWeaponToForm(w));
            }

            document.getElementById('combatant-modal').classList.remove('hidden');
        }

        function closeCombatantModal() {
            document.getElementById('combatant-modal').classList.add('hidden');
        }

        function addWeaponToForm(weaponData = null) {
            if (!isAdmin) return;
            const container = document.getElementById('comb-weapons-list');
            const weaponDiv = document.createElement('div');
            weaponDiv.className = 'weapon-form-entry';
            weaponDiv.style.cssText = 'display:grid;grid-template-columns:1fr 60px 80px 60px 60px 60px auto;gap:5px;align-items:end;margin-bottom:8px;padding:8px;background:rgba(0,0,0,0.3);border:1px solid var(--border-color);';

            const w = weaponData || { name: '', skill: 40, dmg: '1d6', ap: 0, lethality: 0, ammo: null, type: 'melee' };

            weaponDiv.innerHTML = `
                <div class="form-group" style="margin:0;">
                    <label style="font-size:9px;">NAME</label>
                    <input type="text" class="weapon-name" value="${escapeHtml(w.name)}" placeholder="Weapon name">
                </div>
                <div class="form-group" style="margin:0;">
                    <label style="font-size:9px;">SKILL%</label>
                    <input type="number" class="weapon-skill" value="${w.skill}" min="0" max="99">
                </div>
                <div class="form-group" style="margin:0;">
                    <label style="font-size:9px;">DAMAGE</label>
                    <input type="text" class="weapon-dmg" value="${w.dmg}" placeholder="1d6">
                </div>
                <div class="form-group" style="margin:0;">
                    <label style="font-size:9px;">AP</label>
                    <input type="number" class="weapon-ap" value="${w.ap || 0}" min="0">
                </div>
                <div class="form-group" style="margin:0;">
                    <label style="font-size:9px;">LETH%</label>
                    <input type="number" class="weapon-lethality" value="${w.lethality || 0}" min="0" max="100">
                </div>
                <div class="form-group" style="margin:0;">
                    <label style="font-size:9px;">AMMO</label>
                    <input type="number" class="weapon-ammo" value="${w.ammo !== null && w.ammo !== undefined ? w.ammo : ''}" min="0" placeholder="-">
                </div>
                <div style="display:flex;align-items:end;">
                    <button type="button" onclick="this.closest('.weapon-form-entry').remove()" class="btn-danger" style="padding:5px 8px;font-size:10px;">‚úï</button>
                </div>
            `;

            container.appendChild(weaponDiv);
        }

        function saveCombatant() {
            if (!isAdmin) return;

            const indexStr = document.getElementById('combatant-id').value;
            const isEdit = indexStr !== '';

            const weaponEntries = document.querySelectorAll('.weapon-form-entry');
            const weapons = [];
            weaponEntries.forEach(entry => {
                const name = entry.querySelector('.weapon-name').value.trim();
                if (name) {
                    const ammoVal = entry.querySelector('.weapon-ammo').value;
                    weapons.push({
                        name: name,
                        skill: parseInt(entry.querySelector('.weapon-skill').value) || 40,
                        dmg: entry.querySelector('.weapon-dmg').value || '1d6',
                        ap: parseInt(entry.querySelector('.weapon-ap').value) || 0,
                        lethality: parseInt(entry.querySelector('.weapon-lethality').value) || 0,
                        ammo: ammoVal !== '' ? parseInt(ammoVal) : null,
                        type: 'custom'
                    });
                }
            });

            const combatant = {
                id: isEdit ? combatState.combatants[parseInt(indexStr)].id : generateId(),
                name: document.getElementById('comb-name').value.trim() || 'Unnamed',
                type: document.getElementById('comb-type').value,
                str: parseInt(document.getElementById('comb-str').value) || 10,
                dex: parseInt(document.getElementById('comb-dex').value) || 10,
                con: parseInt(document.getElementById('comb-con').value) || 10,
                int: parseInt(document.getElementById('comb-int').value) || 10,
                pow: parseInt(document.getElementById('comb-pow').value) || 10,
                cha: parseInt(document.getElementById('comb-cha').value) || 10,
                hp: parseInt(document.getElementById('comb-hp').value) || 10,
                hpMax: parseInt(document.getElementById('comb-hp-max').value) || 10,
                wp: parseInt(document.getElementById('comb-wp').value) || 10,
                wpMax: parseInt(document.getElementById('comb-wp-max').value) || 10,
                san: parseInt(document.getElementById('comb-san').value) || 50,
                sanMax: 99, 
                armor: parseInt(document.getElementById('comb-armor').value) || 0,
                initBonus: parseInt(document.getElementById('comb-init-bonus').value) || 0,
                // New property for DEX sort tiebreaker (File 1/File 2 compatibility)
                tieBreaker: isEdit ? combatState.combatants[parseInt(indexStr)].tieBreaker : Math.random(),
                firearms: parseInt(document.getElementById('comb-firearms').value) || 20,
                melee: parseInt(document.getElementById('comb-melee').value) || 30,
                unarmed: parseInt(document.getElementById('comb-unarmed').value) || 40,
                dodge: parseInt(document.getElementById('comb-dodge').value) || 30,
                athletics: parseInt(document.getElementById('comb-athletics').value) || 30,
                alertness: parseInt(document.getElementById('comb-alertness').value) || 20,
                weapons: weapons,
                notes: document.getElementById('comb-notes').value,
                statuses: isEdit ? combatState.combatants[parseInt(indexStr)].statuses : [],
                initiative: isEdit ? combatState.combatants[parseInt(indexStr)].initiative : 0,
                isVisible: true
            };

            if (isEdit) {
                combatState.combatants[parseInt(indexStr)] = combatant;
                addLogEntry('system', `<span class="log-actor">${combatant.name}</span> updated.`);
            } else {
                combatState.combatants.push(combatant);
                addLogEntry('system', `<span class="log-actor">${combatant.name}</span> joined combat.`);
            }

            closeCombatantModal();
            saveState();
            renderAll();
        }


        function removeCombatant(index) {
            if (!isAdmin) return;
            if (!confirm(`Remove ${combatState.combatants[index].name} from combat?`)) return;

            const name = combatState.combatants[index].name;
            combatState.combatants.splice(index, 1);

            if (combatState.activeIndex >= index && combatState.activeIndex > 0) {
                combatState.activeIndex--;
            }
            if (combatState.activeIndex >= combatState.combatants.length) {
                combatState.activeIndex = Math.max(0, combatState.combatants.length - 1);
            }

            addLogEntry('system', `${name} removed from combat.`);
            saveState();
            renderAll();
        }

        function clearAllCombatants() {
            if (!isAdmin) return;
            if (!confirm('Remove ALL combatants? This cannot be undone.')) return;

            combatState.combatants = [];
            combatState.activeIndex = -1;
            combatState.round = 1;
            combatState.phase = 'setup';
            combatState.log = [];

            addLogEntry('system', 'All combatants cleared.');
            saveState();
            renderAll();
        }

        function updateCombatantName(index, newName) {
            if (!isAdmin) return;
            combatState.combatants[index].name = newName;
            saveState();
            renderInitiativeList();
        }

        function updateCombatantStat(index, stat, value) {
            if (!isAdmin) return;
            const c = combatState.combatants[index];
            c[stat] = parseInt(value) || 0;

            if (stat === 'hp' && c.hp <= 0 && !c.statuses?.find(s => s.name === 'dying' || s.name === 'dead')) {
                c.hp = 0;
                addStatusToCombatant(index, 'dying', 'negative', 0);
                addLogEntry('damage', `<span class="log-actor">${c.name}</span> is <span class="log-critical">DYING!</span>`);
            }

            saveState();
            renderAll();
        }
        
        // ============================================================
        // ATTACK SYSTEM
        // ============================================================
        
        // ... (Attack system remains the same as File 2) ...

        let currentAttacker = null;

        function openAttackModalFor(index) {
            if (!isAdmin && !canPlayerControl(index)) return;

            currentAttacker = combatState.combatants[index];
            document.getElementById('attack-attacker-name').value = currentAttacker.name;

            const targetSelect = document.getElementById('attack-target');
            targetSelect.innerHTML = '<option value="">-- Select Target --</option>';
            combatState.combatants.forEach((c, i) => {
                if (i !== index && c.hp > 0) {
                    targetSelect.innerHTML += `<option value="${i}">${c.name} (HP: ${c.hp}/${c.hpMax})</option>`;
                }
            });

            const weaponSelect = document.getElementById('attack-weapon');
            weaponSelect.innerHTML = '<option value="">-- Select Weapon --</option>';
            weaponSelect.innerHTML += `<option value="unarmed" data-skill="${currentAttacker.unarmed}" data-dmg="1d4" data-ap="0" data-leth="0">Unarmed (${currentAttacker.unarmed}%)</option>`;

            if (currentAttacker.weapons) {
                currentAttacker.weapons.forEach((w, wi) => {
                    weaponSelect.innerHTML += `<option value="${wi}" data-skill="${w.skill}" data-dmg="${w.dmg}" data-ap="${w.ap || 0}" data-leth="${w.lethality || 0}">${w.name} (${w.skill}%)</option>`;
                });
            }

            document.getElementById('attack-skill').value = currentAttacker.unarmed;
            document.getElementById('attack-modifier').value = 0;
            document.getElementById('attack-aimed').checked = false;
            document.getElementById('attack-called').checked = false;
            document.getElementById('attack-location').disabled = true;
            document.getElementById('attack-result').classList.add('hidden');

            if (currentAttacker.statuses?.some(s => s.name === 'aimed')) {
                document.getElementById('attack-aimed').checked = true;
            }

            updateAttackFinalSkill();
            document.getElementById('attack-modal').classList.remove('hidden');
        }

        function updateAttackSkill() {
            const weaponSelect = document.getElementById('attack-weapon');
            const selected = weaponSelect.options[weaponSelect.selectedIndex];

            if (selected && selected.dataset.skill) {
                document.getElementById('attack-skill').value = selected.dataset.skill;
            }

            updateAttackFinalSkill();
        }

        function updateAttackModifiers() {
            const aimed = document.getElementById('attack-aimed').checked;
            const called = document.getElementById('attack-called').checked;

            document.getElementById('attack-location').disabled = !called;

            updateAttackFinalSkill();
        }

        function updateAttackFinalSkill() {
            const base = parseInt(document.getElementById('attack-skill').value) || 0;
            let mod = parseInt(document.getElementById('attack-modifier').value) || 0;

            if (document.getElementById('attack-aimed').checked) mod += 20;
            if (document.getElementById('attack-called').checked) mod -= 20;

            const final = Math.max(1, Math.min(99, base + mod));
            document.getElementById('attack-final-skill').value = final;
        }

        function executeAttack() {
            const attackerIndex = combatState.combatants.findIndex(c => c.name === currentAttacker.name);
            if (!isAdmin && !canPlayerControl(attackerIndex)) return;

            const targetIndex = document.getElementById('attack-target').value;
            if (!targetIndex) {
                alert('Select a target!');
                return;
            }

            const target = combatState.combatants[parseInt(targetIndex)];
            const skill = parseInt(document.getElementById('attack-final-skill').value) || 40;
            const roll = Math.floor(Math.random() * 100) + 1; // 1d100

            const weaponSelect = document.getElementById('attack-weapon');
            const selectedOption = weaponSelect.options[weaponSelect.selectedIndex];
            const weaponName = selectedOption ? selectedOption.text.split('(')[0].trim() : 'Attack';
            const dmgDice = selectedOption?.dataset.dmg || '1d4';
            const ap = parseInt(selectedOption?.dataset.ap) || 0;
            const lethality = parseInt(selectedOption?.dataset.leth) || 0;

            const calledShot = document.getElementById('attack-called').checked;
            const location = calledShot ? document.getElementById('attack-location').value : 'body';

            if (document.getElementById('attack-aimed').checked) {
                currentAttacker.statuses = currentAttacker.statuses?.filter(s => s.name !== 'aimed') || [];
            }

            const isCritical = roll <= skill && roll % 11 === 0 && roll !== 0;
            const isFumble = (roll > skill && roll % 11 === 0) || roll === 100;
            const isSuccess = roll <= skill;

            let resultHTML = `<div style="text-align:center;padding:15px;background:rgba(0,0,0,0.4);border:1px solid var(--border-color);">
                    <div style="font-size:12px;color:#888;margin-bottom:5px;">ATTACK ROLL</div>
                    <div style="font-size:48px;font-weight:bold;${isSuccess ? 'color:var(--success-color);' : 'color:var(--danger-color);'}">${roll}</div>
                    <div style="font-size:14px;margin:10px 0;">vs <strong>${skill}%</strong></div>`;

            let logMessage = `<span class="log-actor">${currentAttacker.name}</span> attacks <span class="log-target">${target.name}</span> with ${weaponName}. `;
            logMessage += `Roll: <span class="log-roll">${roll}</span> vs ${skill}% - `;

            if (isCritical) {
                resultHTML += `<div class="log-critical" style="font-size:24px;color:#ff00ff;animation:pulse 0.5s infinite;">‚ö° CRITICAL SUCCESS ‚ö°</div>`;
                logMessage += `<span class="log-critical">CRITICAL SUCCESS!</span>`;
            } else if (isFumble) {
                resultHTML += `<div class="log-critical" style="font-size:24px;color:#ff0000;">üíÄ FUMBLE üíÄ</div>`;
                logMessage += `<span class="log-failure">FUMBLE!</span>`;
            } else if (isSuccess) {
                resultHTML += `<div style="font-size:20px;color:var(--success-color);">‚úì HIT</div>`;
                logMessage += `<span class="log-success">HIT!</span>`;

                if (lethality > 0) {
                    const lethRoll = Math.floor(Math.random() * 100) + 1;
                    const killed = lethRoll <= lethality;

                    resultHTML += `<div class="lethality-display" style="margin-top:15px;">
                            <div class="lethality-title">‚ò†Ô∏è LETHALITY CHECK ‚ò†Ô∏è</div>
                            <div class="lethality-roll" style="color:${killed ? 'var(--danger-color)' : 'var(--warning-color)'};">${lethRoll}</div>
                            <div style="margin:10px 0;">vs <strong>${lethality}%</strong> Lethality</div>
                            <div class="lethality-result ${killed ? 'killed' : 'survived'}">${killed ? 'üíÄ INSTANT KILL üíÄ' : 'Target survives...'}</div>
                            ${!killed ? `<div class="lethality-damage">Damage: ${Math.floor(lethRoll / 10) + (lethRoll % 10)} HP (sum of d100 digits)</div>` : ''}
                        </div>`;

                    if (killed) {
                        logMessage += ` <span class="log-critical">LETHAL!</span> - <span class="log-damage">KILLED!</span>`;
                    } else {
                        const lethDmg = Math.floor(lethRoll / 10) + (lethRoll % 10);
                        logMessage += ` Lethality failed - <span class="log-damage">${lethDmg} damage</span>`;
                    }
                } else {
                    const dmgResult = rollDiceExpression(dmgDice);
                    let finalDmg = isCritical ? maximizeDice(dmgDice) : dmgResult.total;

                    const effectiveArmor = Math.max(0, (target.armor || 0) - ap);
                    const armorReduction = effectiveArmor;
                    finalDmg = Math.max(0, finalDmg - armorReduction);

                    resultHTML += `<div style="margin-top:15px;padding:10px;background:rgba(255,0,0,0.1);border:1px solid var(--danger-color);">
                            <div style="font-size:12px;color:#888;">DAMAGE</div>
                            <div style="font-size:32px;font-weight:bold;color:var(--danger-color);">${finalDmg}</div>
                            <div style="font-size:11px;color:#666;">
                                ${dmgDice} = ${dmgResult.total}${isCritical ? ' (maximized)' : ''}
                                ${armorReduction > 0 ? ` - ${armorReduction} armor` : ''}
                                ${ap > 0 ? ` (AP ${ap})` : ''}
                            </div>
                        </div>`;

                    logMessage += ` <span class="log-damage">${finalDmg} damage</span> (${dmgDice}${armorReduction > 0 ? ` - ${armorReduction} armor` : ''})`;

                    if (isAdmin) {
                         resultHTML += `<button onclick="quickApplyDamage(${parseInt(targetIndex)}, ${finalDmg})" class="btn-danger" style="margin-top:15px;width:100%;">
                            üíÄ APPLY ${finalDmg} DAMAGE TO ${target.name.toUpperCase()}
                        </button>`;
                    } else {
                         resultHTML += `<div style="margin-top:10px;font-size:12px;color:var(--warning-color);">DM must apply damage.</div>`;
                    }
                }

                if (calledShot) {
                    resultHTML += `<div style="margin-top:10px;font-size:12px;color:var(--warning-color);">Called Shot: ${location.toUpperCase()}</div>`;
                    logMessage += ` [Called: ${location}]`;
                }
            } else {
                resultHTML += `<div style="font-size:20px;color:var(--danger-color);">‚úó MISS</div>`;
                logMessage += `<span class="log-failure">MISS</span>`;

                if (isAdmin) {
                    resultHTML += `<div style="margin-top:15px;padding:10px;border:1px dashed var(--border-color);">
                        <div style="font-size:11px;color:#888;margin-bottom:5px;">TARGET REACTION (DM Only)</div>
                        <button onclick="rollOpposedDodge(${parseInt(targetIndex)}, ${roll})" style="margin:3px;">üèÉ Dodge (${target.dodge}%)</button>
                        <button onclick="rollOpposedFightBack(${parseInt(targetIndex)}, ${roll})" style="margin:3px;">‚öîÔ∏è Fight Back</button>
                    </div>`;
                }
            }

            resultHTML += '</div>';

            document.getElementById('attack-result').innerHTML = resultHTML;
            document.getElementById('attack-result').classList.remove('hidden');

            addLogEntry('attack', logMessage);
            saveState();
            renderAll(); 
        }

        function closeAttackModal() {
            document.getElementById('attack-modal').classList.add('hidden');
            currentAttacker = null;
            document.getElementById('attack-result').innerHTML = '';
            document.getElementById('attack-result').classList.add('hidden');
        }

        // ... (Damage system remains the same as File 2) ...

        // ============================================================
        // DAMAGE SYSTEM
        // ============================================================

        function openDamageModalFor(targetIndex) {
            if (!isAdmin) return;

            const targetSelect = document.getElementById('damage-target');
            targetSelect.innerHTML = '<option value="">-- Select Target --</option>';
            combatState.combatants.forEach((c, i) => {
                const selected = i === targetIndex ? 'selected' : '';
                targetSelect.innerHTML += `<option value="${i}" ${selected}>${c.name} (HP: ${c.hp}/${c.hpMax}, Armor: ${c.armor})</option>`;
            });

            document.getElementById('damage-dice').value = '';
            document.getElementById('damage-flat').value = '';
            document.getElementById('damage-lethality').value = '';
            document.getElementById('damage-ap').value = 0;
            document.getElementById('damage-bypass-armor').checked = false;
            document.getElementById('damage-type').value = 'physical';
            document.getElementById('damage-result').classList.add('hidden');

            document.getElementById('damage-modal').classList.remove('hidden');
        }

        function closeDamageModal() {
            document.getElementById('damage-modal').classList.add('hidden');
            document.getElementById('damage-result').innerHTML = '';
            document.getElementById('damage-result').classList.add('hidden');
        }

        function applyDamage() {
            if (!isAdmin) return;

            const targetIndex = document.getElementById('damage-target').value;
            if (!targetIndex) {
                alert('Select a target!');
                return;
            }

            const target = combatState.combatants[parseInt(targetIndex)];
            const dice = document.getElementById('damage-dice').value.trim();
            const flat = parseInt(document.getElementById('damage-flat').value) || 0;
            const lethality = parseInt(document.getElementById('damage-lethality').value) || 0;
            const ap = parseInt(document.getElementById('damage-ap').value) || 0;
            const bypassArmor = document.getElementById('damage-bypass-armor').checked;
            const damageType = document.getElementById('damage-type').value;

            let damage = 0;
            let resultHTML = '<div style="text-align:center;">';
            let logMessage = `<span class="log-target">${target.name}</span> `;

            if (lethality > 0) {
                const lethRoll = Math.floor(Math.random() * 100) + 1;
                const killed = lethRoll <= lethality;

                resultHTML += `<div class="lethality-display">... (Lethality result) ...</div>`; // Simplified for brevity in comment

                if (killed) {
                    target.hp = 0;
                    addStatusToCombatant(parseInt(targetIndex), 'dead', 'negative', 0);
                    logMessage += `fails lethality check (${lethRoll} vs ${lethality}%) - <span class="log-critical">KILLED!</span>`;
                } else {
                    damage = Math.floor(lethRoll / 10) + (lethRoll % 10);
                    logMessage += `survives lethality (${lethRoll} vs ${lethality}%) but takes <span class="log-damage">${damage} damage</span>`;
                }
            } else if (dice || flat) {
                if (dice) {
                    const diceResult = rollDiceExpression(dice);
                    damage = diceResult.total + flat;
                } else {
                    damage = flat;
                }
                logMessage += `takes <span class="log-damage">${damage} ${damageType} damage</span>`;
            } else {
                alert('Enter dice expression or flat damage!');
                return;
            }

            if (damage > 0 && !bypassArmor && target.hp > 0) {
                const effectiveArmor = Math.max(0, (target.armor || 0) - ap);
                if (effectiveArmor > 0) {
                    const reduction = Math.min(effectiveArmor, damage);
                    damage = Math.max(0, damage - reduction);
                    logMessage += ` (${reduction} absorbed by armor)`;
                }
            }

            if (target.hp > 0) {
                const oldHp = target.hp;
                const oldWp = target.wp;
                const oldSan = target.san;

                if (damageType === 'psychic') {
                    target.wp = Math.max(0, target.wp - damage);
                } else if (damageType === 'san') {
                    target.san = Math.max(0, (target.san || 50) - damage);
                } else {
                    target.hp = Math.max(0, target.hp - damage);
                }

                if (damageType !== 'san' && damageType !== 'psychic' && target.hp <= 0 && oldHp > 0) {
                    addStatusToCombatant(parseInt(targetIndex), 'dying', 'negative', 0);
                    logMessage += ` - <span class="log-critical">DYING!</span>`;
                }
            }

            resultHTML += '</div>';

            document.getElementById('damage-result').innerHTML = resultHTML; // Needs proper rendering here for full effect
            document.getElementById('damage-result').classList.remove('hidden');

            addLogEntry('damage', logMessage);
            saveState();
            renderAll();
        }

        function applyHealing() {
            if (!isAdmin) return;
            const targetIndex = document.getElementById('damage-target').value;
            if (!targetIndex) {
                alert('Select a target!');
                return;
            }

            const target = combatState.combatants[parseInt(targetIndex)];
            const dice = document.getElementById('damage-dice').value.trim();
            const flat = parseInt(document.getElementById('damage-flat').value) || 0;
            const damageType = document.getElementById('damage-type').value; // Used for WP/HP healing

            let healing = 0;

            if (dice) {
                healing = rollDiceExpression(dice).total + flat;
            } else if (flat) {
                healing = flat;
            } else {
                alert('Enter dice or flat amount!');
                return;
            }

            const oldHp = target.hp;
            const oldWp = target.wp;
            let actualHeal = 0;
            let resourceType = 'HP';

            if (damageType === 'psychic') {
                target.wp = Math.min(target.wpMax, target.wp + healing);
                actualHeal = target.wp - oldWp;
                resourceType = 'WP';
            } else {
                target.hp = Math.min(target.hpMax, target.hp + healing);
                actualHeal = target.hp - oldHp;
            }

            if (target.hp > 0) {
                target.statuses = (target.statuses || []).filter(s => s.name !== 'dying');
            }

            addLogEntry('heal', `<span class="log-target">${target.name}</span> heals <span class="log-success">+${actualHeal} ${resourceType}</span>`);
            saveState();
            renderAll();
        }

        // ... (rest of the file 2 functions for status, dice, actions, settings, etc.) ...
        
        // ============================================================
        // STATUS EFFECTS
        // ============================================================

        function openStatusModalFor(targetIndex) {
            if (!isAdmin) return;

            const targetSelect = document.getElementById('status-target');
            targetSelect.innerHTML = '<option value="">-- Select Target --</option>';
            combatState.combatants.forEach((c, i) => {
                const selected = i === targetIndex ? 'selected' : '';
                targetSelect.innerHTML += `<option value="${i}" ${selected}>${c.name}</option>`;
            });

            document.getElementById('status-type').value = 'prone|negative';
            document.getElementById('status-duration').value = 0;
            document.getElementById('status-custom').value = '';

            document.getElementById('status-modal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('status-modal').classList.add('hidden');
        }

        function applyStatus() {
            if (!isAdmin) return;
            const targetIndex = document.getElementById('status-target').value;
            if (!targetIndex) {
                alert('Select a target!');
                return;
            }

            const customStatus = document.getElementById('status-custom').value.trim();
            let statusName, statusType;

            if (customStatus) {
                statusName = customStatus;
                statusType = 'neutral';
            } else {
                const statusValue = document.getElementById('status-type').value;
                [statusName, statusType] = statusValue.split('|');
            }

            const duration = parseInt(document.getElementById('status-duration').value) || 0;

            addStatusToCombatant(parseInt(targetIndex), statusName, statusType, duration);

            const target = combatState.combatants[parseInt(targetIndex)];
            addLogEntry('status', `<span class="log-target">${target.name}</span> gains status: <strong>${statusName}</strong>${duration > 0 ? ` (${duration} rounds)` : ''}`);

            closeStatusModal();
            saveState();
            renderAll();
        }

        function addStatusToCombatant(index, name, type, duration) {
            const c = combatState.combatants[index];
            if (!c.statuses) c.statuses = [];

            c.statuses = c.statuses.filter(s => s.name !== name);

            c.statuses.push({ name, type, duration });
        }

        function removeStatus(combatantIndex, statusName) {
            if (!isAdmin) return;

            const c = combatState.combatants[combatantIndex];
            c.statuses = (c.statuses || []).filter(s => s.name !== statusName);

            addLogEntry('status', `<span class="log-target">${c.name}</span> loses status: ${statusName}`);
            saveState();
            renderAll();
        }

        function tickStatusDurations(combatantIndex) {
            if (!isAdmin) return; 

            const c = combatState.combatants[combatantIndex];
            if (!c.statuses) return;

            const expiredStatuses = [];

            c.statuses = c.statuses.filter(s => {
                if (s.duration > 0) {
                    s.duration--;
                    if (s.duration <= 0) {
                        expiredStatuses.push(s.name);
                        return false;
                    }
                }
                return true;
            });

            expiredStatuses.forEach(name => {
                addLogEntry('status', `<span class="log-target">${c.name}</span> status expired: ${name}`);
            });

            const oldHp = c.hp;
            if (c.statuses.some(s => s.name === 'bleeding')) {
                const bleedDmg = Math.floor(Math.random() * 3) + 1; // 1d3
                c.hp = Math.max(0, c.hp - bleedDmg);
                addLogEntry('damage', `<span class="log-target">${c.name}</span> bleeds for <span class="log-damage">${bleedDmg} damage</span>`);
            }

            if (c.statuses.some(s => s.name === 'burning')) {
                const burnDmg = Math.floor(Math.random() * 6) + 1; // 1d6
                c.hp = Math.max(0, c.hp - burnDmg);
                addLogEntry('damage', `<span class="log-target">${c.name}</span> burns for <span class="log-damage">${burnDmg} damage</span>`);
            }

            if (c.statuses.some(s => s.name === 'poisoned')) {
                const poisonDmg = Math.floor(Math.random() * 4) + 1; // 1d4
                c.hp = Math.max(0, c.hp - poisonDmg);
                addLogEntry('damage', `<span class="log-target">${c.name}</span> takes <span class="log-damage">${poisonDmg} poison damage</span>`);
            }

            if (c.hp <= 0 && oldHp > 0) {
                addStatusToCombatant(combatantIndex, 'dying', 'negative', 0);
                addLogEntry('damage', `<span class="log-actor">${c.name}</span> is <span class="log-critical">DYING!</span> from recurring damage.`);
            }

            saveState(); 
        }

        // ============================================================
        // DICE ROLLING
        // ============================================================

        function rollDice(expression) {
            const result = rollDiceExpression(expression);

            document.getElementById('dice-result').innerHTML = `
                <div class="result-value">${result.total}</div>
                <div class="result-breakdown">${expression}: ${result.breakdown}</div>
            `;

            const rollerName = isAdmin ? 'ADMIN' : 'PLAYER';
            addLogEntry('system', `<span class="log-actor">${rollerName}</span> rolled: <span class="log-roll">${expression} = ${result.total}</span> (${result.breakdown})`);
            saveState();
        }

        function rollDiceExpression(expr) {
            const cleanExpr = expr.toLowerCase().replace(/\s+/g, '');

            let total = 0;
            let breakdown = [];

            const parts = cleanExpr.split(/(?=[+-])/);

            parts.forEach(part => {
                const sign = part.startsWith('-') ? -1 : 1;
                const cleanPart = part.replace(/^[+-]/, '');

                if (cleanPart.includes('d')) {
                    const match = cleanPart.match(/(\d*)d(\d+)(kh\d+|kl\d+)?/);
                    if (match) {
                        const count = parseInt(match[1]) || 1;
                        const sides = parseInt(match[2]);
                        const keep = match[3];

                        let rolls = [];
                        for (let i = 0; i < count; i++) {
                            rolls.push(Math.floor(Math.random() * sides) + 1);
                        }

                        if (keep) {
                            const keepCount = parseInt(keep.substring(2));
                            rolls.sort((a, b) => keep.startsWith('kh') ? b - a : a - b);
                            
                            const keptRolls = rolls.slice(0, keepCount);
                            const sum = keptRolls.reduce((a, b) => a + b, 0) * sign;
                            total += sum;

                            let breakdownRolls = rolls.map(r => {
                                if (keptRolls.includes(r)) {
                                    const index = keptRolls.indexOf(r);
                                    if (index !== -1) {
                                        keptRolls.splice(index, 1);
                                        return r;
                                    }
                                }
                                return `<s>${r}</s>`;
                            });
                            
                            breakdown.push(`[${breakdownRolls.join(', ')}]`);
                        } else {
                            const sum = rolls.reduce((a, b) => a + b, 0) * sign;
                            total += sum;
                            breakdown.push(`[${rolls.join(', ')}]`);
                        }
                    }
                } else {
                    const num = parseInt(cleanPart) * sign;
                    if (!isNaN(num)) {
                        total += num;
                        if (num !== 0) {
                            breakdown.push(num > 0 ? `+${num}` : num.toString());
                        }
                    }
                }
            });

            return { total, breakdown: breakdown.join(' ') || total.toString() };
        }

        function maximizeDice(expr) {
            const cleanExpr = expr.toLowerCase().replace(/\s+/g, '');
            let total = 0;

            const parts = cleanExpr.split(/(?=[+-])/);

            parts.forEach(part => {
                const sign = part.startsWith('-') ? -1 : 1;
                const cleanPart = part.replace(/^[+-]/, '');

                if (cleanPart.includes('d')) {
                    const match = cleanPart.match(/(\d*)d(\d+)/);
                    if (match) {
                        const count = parseInt(match[1]) || 1;
                        const sides = parseInt(match[2]);
                        total += (count * sides) * sign;
                    }
                } else {
                    const num = parseInt(cleanPart) * sign;
                    if (!isNaN(num)) total += num;
                }
            });

            return total;
        }

        function openCustomRollModal() {
            document.getElementById('custom-dice-expr').value = '';
            document.getElementById('custom-roll-label').value = '';
            document.getElementById('custom-roll-modal').classList.remove('hidden');
        }

        function closeCustomRollModal() {
            document.getElementById('custom-roll-modal').classList.add('hidden');
        }

        function executeCustomRoll() {
            const expr = document.getElementById('custom-dice-expr').value.trim();
            const label = document.getElementById('custom-roll-label').value.trim();

            if (!expr) {
                alert('Enter a dice expression!');
                return;
            }

            const result = rollDiceExpression(expr);

            document.getElementById('dice-result').innerHTML = `
                <div class="result-value">${result.total}</div>
                <div class="result-breakdown">${label ? label + ': ' : ''}${expr}: ${result.breakdown}</div>
            `;

            const rollerName = isAdmin ? 'ADMIN' : 'PLAYER';
            addLogEntry('system', `<span class="log-actor">${rollerName}</span> rolled ${label ? label + ' - ' : ''}: <span class="log-roll">${expr} = ${result.total}</span>`);

            closeCustomRollModal();
            saveState();
        }

        // ============================================================
        // COMBAT LOG
        // ============================================================

        function addLogEntry(type, message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });

            combatState.log.push({
                type,
                message,
                timestamp,
                round: combatState.round
            });

            if (combatState.log.length > 500) {
                combatState.log = combatState.log.slice(-300);
            }

            renderCombatLog();
        }

        function clearLog() {
            if (!isAdmin) return;
            if (!confirm('Clear combat log?')) return;

            combatState.log = [];
            addLogEntry('system', 'Combat log cleared.');
            saveState();
        }

        // ============================================================
        // ACTIONS
        // ============================================================

        function performAction(actionType) {
            const activeIndex = combatState.activeIndex;
            if (activeIndex === -1 || combatState.phase !== 'active') return;

            if (!isAdmin && !canPlayerControl(activeIndex)) return;

            const active = combatState.combatants[activeIndex];

            switch (actionType) {
                case 'attack':
                    openAttackModalFor(activeIndex);
                    break;
                case 'aim':
                    addStatusToCombatant(activeIndex, 'aimed', 'positive', 1);
                    addLogEntry('move', `<span class="log-actor">${active.name}</span> takes aim (+20% to next attack).`);
                    saveState();
                    renderAll();
                    break;
                case 'dodge':
                    addStatusToCombatant(activeIndex, 'dodging', 'positive', 1);
                    addLogEntry('move', `<span class="log-actor">${active.name}</span> prepares to dodge.`);
                    saveState();
                    renderAll();
                    break;
                case 'move':
                    const moveDist = active.dex * 3; 
                    addLogEntry('move', `<span class="log-actor">${active.name}</span> moves (up to ${moveDist}ft).`);
                    saveState();
                    break;
                case 'fightback':
                    addLogEntry('attack', `<span class="log-actor">${active.name}</span> readies to fight back against next attacker.`);
                    addStatusToCombatant(activeIndex, 'ready to counter', 'positive', 1);
                    saveState();
                    renderAll();
                    break;
                case 'disarm':
                    if (isAdmin) performDisarm(); else alert("Only the Handler can resolve Disarm checks.");
                    break;
                case 'reload':
                    addLogEntry('move', `<span class="log-actor">${active.name}</span> reloads their weapon.`);
                    saveState();
                    break;
                case 'firstaid':
                    if (isAdmin) performFirstAid(); else alert("Only the Handler can resolve First Aid checks.");
                    break;
                case 'called':
                    openAttackModalFor(activeIndex);
                    setTimeout(() => {
                        document.getElementById('attack-called').checked = true;
                        updateAttackModifiers();
                    }, 100);
                    break;
                case 'pin':
                    if (isAdmin) performPin(); else alert("Only the Handler can resolve Pin checks.");
                    break;
                case 'delay':
                    addStatusToCombatant(activeIndex, 'delayed', 'neutral', 0);
                    addLogEntry('move', `<span class="log-actor">${active.name}</span> delays their turn.`);
                    saveState();
                    renderAll();
                    break;
                case 'other':
                    const action = prompt('Describe the action:');
                    if (action) {
                        addLogEntry('move', `<span class="log-actor">${active.name}</span>: ${escapeHtml(action)}`);
                        saveState();
                    }
                    break;
            }
        }
        
        function performDisarm() {
            if (!isAdmin) return;
            const active = combatState.combatants[combatState.activeIndex];

            const targets = combatState.combatants
                .filter((c, i) => i !== combatState.activeIndex && c.hp > 0)
                .map(c => c.name);

            if (targets.length === 0) {
                alert('No valid targets!');
                return;
            }

            const targetName = prompt(`Disarm who?\n${targets.join('\n')}`);
            if (!targetName) return;

            const targetIndex = combatState.combatants.findIndex(c =>
                c.name.toLowerCase() === targetName.toLowerCase()
            );

            if (targetIndex === -1) {
                alert('Target not found!');
                return;
            }

            const target = combatState.combatants[targetIndex];
            const skill = active.unarmed; 
            const roll = Math.floor(Math.random() * 100) + 1;
            const success = roll <= skill;

            let message = `<span class="log-actor">${active.name}</span> attempts to disarm <span class="log-target">${target.name}</span>: `;
            message += `<span class="log-roll">${roll}</span> vs ${skill}% - `;

            if (success) {
                message += `<span class="log-success">SUCCESS!</span> Target is disarmed!`;
                addStatusToCombatant(targetIndex, 'disarmed', 'negative', 0);
            } else {
                message += `<span class="log-failure">FAILED</span>`;
            }

            addLogEntry('attack', message);
            saveState();
            renderAll();
        }

        function performFirstAid() {
            if (!isAdmin) return;
            const active = combatState.combatants[combatState.activeIndex];

            const targets = combatState.combatants
                .filter(c => c.hp < c.hpMax)
                .map(c => c.name);

            if (targets.length === 0) {
                alert('No one needs healing!');
                return;
            }

            const targetName = prompt(`Perform First Aid on who?\n${targets.join('\n')}`);
            if (!targetName) return;

            const targetIndex = combatState.combatants.findIndex(c =>
                c.name.toLowerCase() === targetName.toLowerCase()
            );

            if (targetIndex === -1) {
                alert('Target not found!');
                return;
            }

            const target = combatState.combatants[targetIndex];
            const firstAidSkill = active.firstaid || 30; 
            const roll = Math.floor(Math.random() * 100) + 1;
            const success = roll <= firstAidSkill;
            const isCritical = success && roll % 11 === 0 && roll !== 0;

            let message = `<span class="log-actor">${active.name}</span> performs First Aid on <span class="log-target">${target.name}</span>: `;
            message += `<span class="log-roll">${roll}</span> vs ${firstAidSkill}% - `;

            if (isCritical) {
                const healing = Math.floor(Math.random() * 4) + 2; 
                target.hp = Math.min(target.hpMax, target.hp + healing);
                target.statuses = (target.statuses || []).filter(s => s.name !== 'dying' && s.name !== 'bleeding');
                message += `<span class="log-critical">CRITICAL!</span> Heals <span class="log-success">${healing} HP</span> and stabilizes!`;
            } else if (success) {
                const healing = 1;
                target.hp = Math.min(target.hpMax, target.hp + healing);
                target.statuses = (target.statuses || []).filter(s => s.name !== 'dying');
                message += `<span class="log-success">SUCCESS!</span> Heals <span class="log-success">${healing} HP</span> and stabilizes.`;
            } else {
                message += `<span class="log-failure">FAILED</span>`;
            }

            addLogEntry('heal', message);
            saveState();
            renderAll();
        }

        function performPin() {
            if (!isAdmin) return;
            const active = combatState.combatants[combatState.activeIndex];

            const targets = combatState.combatants
                .filter((c, i) => i !== combatState.activeIndex && c.hp > 0)
                .map(c => c.name);

            if (targets.length === 0) {
                alert('No valid targets!');
                return;
            }

            const targetName = prompt(`Pin who?\n${targets.join('\n')}`);
            if (!targetName) return;

            const targetIndex = combatState.combatants.findIndex(c =>
                c.name.toLowerCase() === targetName.toLowerCase()
            );

            if (targetIndex === -1) {
                alert('Target not found!');
                return;
            }

            const target = combatState.combatants[targetIndex];

            const attackerStr = active.str * 5;
            const defenderStr = target.str * 5;

            const attackRoll = Math.floor(Math.random() * 100) + 1;
            const defendRoll = Math.floor(Math.random() * 100) + 1;

            const attackSuccess = attackRoll <= attackerStr;
            const defendSuccess = defendRoll <= defenderStr;

            let message = `<span class="log-actor">${active.name}</span> attempts to pin <span class="log-target">${target.name}</span>. `;
            message += `Attacker: <span class="log-roll">${attackRoll}</span> vs ${attackerStr}%, `;
            message += `Defender: <span class="log-roll">${defendRoll}</span> vs ${defenderStr}% - `;

            if (attackSuccess && (!defendSuccess || attackRoll < defendRoll)) {
                addStatusToCombatant(targetIndex, 'pinned', 'negative', 0);
                addStatusToCombatant(combatState.activeIndex, 'pinning', 'neutral', 0);
                message += `<span class="log-success">PINNED!</span>`;
            } else {
                message += `<span class="log-failure">RESISTED</span>`;
            }

            addLogEntry('attack', message);
            saveState();
            renderAll();
        }

        // ============================================================
        // SETTINGS & SHARING
        // ============================================================

        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');

            document.getElementById('setting-player-view').checked = combatState.settings.playerViewEnabled;
            document.getElementById('setting-show-enemy-hp').checked = combatState.settings.showEnemyHp;
            document.getElementById('setting-show-enemy-stats').checked = combatState.settings.showEnemyStats;
            document.getElementById('setting-use-dex-sort').checked = combatState.settings.useDexSort;

            updateShareLink();
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');

            combatState.settings.playerViewEnabled = document.getElementById('setting-player-view').checked;
            combatState.settings.showEnemyHp = document.getElementById('setting-show-enemy-hp').checked;
            combatState.settings.showEnemyStats = document.getElementById('setting-show-enemy-stats').checked;
            combatState.settings.useDexSort = document.getElementById('setting-use-dex-sort').checked;
            
            // Save settings to localStorage too (File 1 feature)
            localStorage.setItem('aotd_settings', JSON.stringify(combatState.settings));

            saveState();
            renderAll();
        }

        function togglePlayerSharing() {
            combatState.settings.playerViewEnabled = document.getElementById('setting-player-view').checked;
            updateShareLink();
            saveState();
        }

        function updateShareLink() {
            const shareInput = document.getElementById('share-link');

            if (combatState.settings.playerViewEnabled) {
                const baseUrl = window.location.origin + window.location.pathname;
                const playerUrl = `${baseUrl}?session=${combatSessionId}&mode=player`;
                shareInput.value = playerUrl;
            } else {
                shareInput.value = 'Enable player view to generate link';
            }
        }

        function copyShareLink() {
            const shareInput = document.getElementById('share-link');
            shareInput.select();
            document.execCommand('copy');

            alert('Link copied to clipboard!');
        }

        // ============================================================
        // SCREENSHOT
        // ============================================================

        async function screenshotCombat() {
            const element = document.getElementById('screenshot-area');

            try {
                const wasAdmin = isAdmin;
                isAdmin = true;
                const wasPlayerMode = isPlayerMode;
                isPlayerMode = false;
                document.body.classList.remove('player-mode');
                renderAll(); 

                element.style.maxWidth = 'none';

                const canvas = await html2canvas(element, {
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-color'),
                    scale: 2,
                    logging: false,
                    useCORS: true
                });

                element.style.maxWidth = '';
                isAdmin = wasAdmin;
                isPlayerMode = wasPlayerMode;
                if(isPlayerMode) document.body.classList.add('player-mode');
                renderAll();


                const link = document.createElement('a');
                link.download = `combat_round${combatState.round}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                addLogEntry('system', 'üì∑ Combat screenshot saved.');
            } catch (error) {
                console.error('Screenshot failed:', error);
                alert('Screenshot failed. Check console for details.');
            }
        }

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden'));
        }

        // ============================================================
        // PLAYER MODE RESTRICTIONS
        // ============================================================

        function canPlayerControl(combatantIndex) {
            if (isAdmin) return true;
            if (!isPlayerMode) return false;

            const c = combatState.combatants[combatantIndex];
            if (!c) return false;

            return combatState.settings.playerViewEnabled &&
                   combatantIndex === combatState.activeIndex &&
                   c.type === 'player';
        }

        function applyPlayerModeRestrictions() {
            if (!isPlayerMode) return;

            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'none';
            });

            document.querySelectorAll('.combatant-card').forEach(card => {
                const index = parseInt(card.dataset.index);
                const isControlled = canPlayerControl(index);

                card.querySelectorAll('input, button').forEach(el => {
                    if (el.classList.contains('admin-only')) return;

                    if (!isControlled) {
                        el.disabled = true;
                        if (el.tagName === 'INPUT') el.readOnly = true;
                    } else {
                        el.disabled = false;
                        if (el.tagName === 'INPUT') el.readOnly = false;
                    }
                });

                if (index !== combatState.activeIndex) {
                    card.querySelector('.card-actions')?.style.setProperty('display', 'none', 'important');
                } else {
                    card.querySelector('.card-actions')?.style.removeProperty('display');
                }
            });


            document.querySelectorAll('.combatant-card.enemy').forEach(card => {
                if (!combatState.settings.showEnemyStats) {
                    card.querySelector('.attributes-grid')?.classList.add('hidden');
                    card.querySelector('.skills-section')?.classList.add('hidden');
                } else {
                    card.querySelector('.attributes-grid')?.classList.remove('hidden');
                    card.querySelector('.skills-section')?.classList.remove('hidden');
                }

                if (!combatState.settings.showEnemyHp) {
                    const hpContainer = card.querySelector('.stat-bar-container:first-child');
                    if (hpContainer) hpContainer.style.setProperty('display', 'none', 'important');
                } else {
                    const hpContainer = card.querySelector('.stat-bar-container:first-child');
                    if (hpContainer) hpContainer.style.removeProperty('display');
                }
            });
        }

        console.log('Afraid of the Dark Combat Manager initialized. (Unified Version)');
        console.log('Keyboard shortcuts: N = Next turn, R = Roll d100, Esc = Close modals');
    </script>
</body>
</html>
